<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoToMarket - Product Compliance & Market Entry Architecture</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Sora:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
<style>
  :root {
    --bg-0: #080B10;
    --bg-1: #0D1219;
    --bg-2: #131A24;
    --bg-3: #1A2435;
    --bg-4: #223046;
    --text-0: #F0F4F8;
    --text-1: #C1CEDC;
    --text-2: #8299B4;
    --text-3: #566B84;
    --accent: #2DD4A8;
    --accent-dim: #1FA880;
    --accent-glow: rgba(45,212,168,0.1);
    --accent-glow2: rgba(45,212,168,0.06);
    --gold: #E8B94A;
    --gold-dim: rgba(232,185,74,0.1);
    --success: #34D399; --success-dim: rgba(52,211,153,0.1);
    --warn: #FBBF24; --warn-dim: rgba(251,191,36,0.1);
    --danger: #F87171; --danger-dim: rgba(248,113,113,0.1);
    --info: #60A5FA; --info-dim: rgba(96,165,250,0.1);
    --border: rgba(255,255,255,0.06);
    --border-accent: rgba(45,212,168,0.25);
    --r: 14px; --r-lg: 20px;
    --font-d: 'Playfair Display', Georgia, serif;
    --font-b: 'Sora', sans-serif;
    --font-cn: 'Noto Sans SC', sans-serif;
    --font-m: 'JetBrains Mono', monospace;
    --pad: clamp(20px, 4vw, 56px);
  }
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
  body{font-family:var(--font-b);background:var(--bg-0);color:var(--text-0);min-height:100vh;overflow-x:hidden;font-size:15px;line-height:1.6}
  body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");pointer-events:none;z-index:10000}
  ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg-0)}::-webkit-scrollbar-thumb{background:var(--bg-4);border-radius:3px}
  a{color:inherit;text-decoration:none}

  /* NAV */
  nav{position:fixed;top:0;left:0;right:0;z-index:100;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 var(--pad);background:rgba(8,11,16,0.85);backdrop-filter:blur(24px);border-bottom:1px solid var(--border)}
  .nav-brand{display:flex;align-items:center;gap:12px}
  .nav-logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-dim));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:var(--bg-0)}
  .nav-name{font-family:var(--font-d);font-size:17px;font-weight:600}.nav-name em{font-style:italic;color:var(--accent)}
  .nav-r{display:flex;align-items:center;gap:3px}
  .nav-link{padding:6px 14px;border-radius:7px;font-size:12px;font-weight:500;color:var(--text-2);cursor:pointer;transition:all .2s}
  .nav-link:hover{color:var(--text-0);background:var(--bg-3)}.nav-link.active{color:var(--accent);background:var(--accent-glow)}
  .lang-sw{display:flex;margin-left:12px;background:var(--bg-2);border-radius:7px;border:1px solid var(--border);overflow:hidden}
  .lang-btn{padding:5px 12px;font-size:11px;font-weight:600;background:transparent;border:none;color:var(--text-3);cursor:pointer;font-family:var(--font-b);transition:all .2s}
  .lang-btn.active{background:var(--accent);color:var(--bg-0)}

  /* HERO ‚Äî compact */
  .hero{padding:90px var(--pad) 40px;position:relative;overflow:hidden}
  .hero-orb{position:absolute;border-radius:50%;pointer-events:none;filter:blur(90px);opacity:.35}
  .hero-orb-1{width:500px;height:500px;top:-120px;right:-80px;background:radial-gradient(circle,rgba(45,212,168,.16),transparent 70%);animation:of 12s ease-in-out infinite}
  .hero-orb-2{width:350px;height:350px;bottom:-80px;left:8%;background:radial-gradient(circle,rgba(96,165,250,.08),transparent 70%);animation:of 15s ease-in-out infinite reverse}
  @keyframes of{0%,100%{transform:translate(0,0) scale(1)}50%{transform:translate(25px,-15px) scale(1.06)}}
  .hero-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,.018) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,.018) 1px,transparent 1px);background-size:64px 64px;mask-image:radial-gradient(ellipse at 65% 35%,black 10%,transparent 60%)}
  .hero-inner{position:relative;max-width:800px;width:100%}
  .hero-badge{display:inline-flex;align-items:center;gap:8px;padding:5px 16px;border-radius:100px;background:var(--accent-glow);border:1px solid var(--border-accent);font-size:11px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:24px;animation:fu .5s ease both}
  .hero-badge::before{content:'';width:5px;height:5px;background:var(--accent);border-radius:50%;animation:pu 2s infinite}
  @keyframes pu{0%,100%{opacity:1}50%{opacity:.3}}
  .hero h1{font-family:var(--font-b);font-size:clamp(32px,4.5vw,52px);line-height:1.15;letter-spacing:-0.5px;font-weight:700;margin-bottom:16px;animation:fu .5s .06s ease both}
  .hero h1 em{font-style:normal;color:var(--accent)}
  .hero-desc{font-size:16px;line-height:1.7;color:var(--text-1);max-width:560px;margin-bottom:28px;animation:fu .5s .12s ease both}
  .hero-actions{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:40px;animation:fu .5s .18s ease both}
  @keyframes fu{from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:translateY(0)}}
  .btn{padding:12px 26px;border-radius:10px;font-size:13px;font-weight:600;font-family:var(--font-b);cursor:pointer;transition:all .25s;border:none;display:inline-flex;align-items:center;gap:9px}
  .btn-accent{background:linear-gradient(135deg,var(--accent),var(--accent-dim));color:var(--bg-0);box-shadow:0 4px 18px rgba(45,212,168,.22),inset 0 1px 0 rgba(255,255,255,.12)}
  .btn-accent:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(45,212,168,.32),inset 0 1px 0 rgba(255,255,255,.12)}
  .btn-ghost{background:var(--bg-3);color:var(--text-0);border:1px solid var(--border)}
  .btn-ghost:hover{background:var(--bg-4);border-color:var(--text-3)}
  .btn-sm{padding:9px 20px;font-size:12px;border-radius:8px}

  /* UPLOAD */
  .upload-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;animation:fu .5s .24s ease both}
  .upload-zone{background:var(--bg-2);border:2px dashed rgba(45,212,168,.18);border-radius:var(--r-lg);padding:36px 28px;text-align:center;cursor:pointer;transition:all .3s}
  .upload-zone:hover,.upload-zone.dragover{border-color:var(--accent);background:var(--bg-3);box-shadow:0 0 30px rgba(45,212,168,.05)}
  .upload-icon-wrap{width:60px;height:60px;margin:0 auto 16px;border-radius:16px;background:linear-gradient(135deg,var(--accent-glow),var(--accent-glow2));border:1px solid var(--border-accent);display:flex;align-items:center;justify-content:center;font-size:28px}
  .upload-title{font-size:15px;font-weight:600;margin-bottom:5px}
  .upload-desc{font-size:12px;color:var(--text-3);line-height:1.5}
  .upload-formats{margin-top:14px;display:flex;justify-content:center;gap:6px}
  .fmt{padding:3px 10px;border-radius:5px;background:var(--bg-4);font-size:9px;font-weight:700;color:var(--text-3);letter-spacing:.8px;font-family:var(--font-m)}
  .file-list{margin-top:14px;display:flex;flex-direction:column;gap:6px}
  .file-item{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;background:var(--bg-3);font-size:12px;animation:fu .25s ease both}
  .file-item .fn{flex:1;color:var(--text-1);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .file-item .fs{color:var(--text-3);font-size:10px;font-family:var(--font-m)}
  .file-item .fx{width:20px;height:20px;border-radius:5px;background:var(--danger-dim);border:none;color:var(--danger);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:10px;transition:all .2s}
  .file-item .fx:hover{background:var(--danger);color:#fff}

  .upload-info{background:var(--bg-2);border-radius:var(--r-lg);border:1px solid var(--border);padding:28px;display:flex;flex-direction:column;justify-content:center}
  .info-title{font-size:14px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}
  .info-list{display:flex;flex-direction:column;gap:10px}
  .info-item{display:flex;align-items:flex-start;gap:10px;font-size:13px;color:var(--text-1)}
  .info-dot{width:24px;height:24px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
  .iit-t{font-weight:600;font-size:12px;margin-bottom:1px}
  .iit-d{font-size:11px;color:var(--text-3);line-height:1.4}

  /* Analyze button & status */
  .analyze-bar{margin-top:20px;display:flex;align-items:center;gap:16px;animation:fu .5s .3s ease both}
  .analyze-status{font-size:13px;color:var(--text-2)}
  .analyze-status.error{color:var(--danger)}
  .spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--bg-4);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* SECTION COMMON */
  .section{padding:60px var(--pad)}
  .divider{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:0 var(--pad)}
  .sec-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:2.5px;color:var(--accent);margin-bottom:10px;font-family:var(--font-m)}
  .sec-title{font-family:var(--font-d);font-size:clamp(26px,3vw,38px);letter-spacing:-.8px;font-weight:700;margin-bottom:10px;line-height:1.15}
  .sec-desc{font-size:14px;color:var(--text-2);max-width:540px;line-height:1.7;margin-bottom:40px}

  /* SERVICES */
  .svc-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px}
  .svc-card{background:var(--bg-2);border-radius:var(--r-lg);border:1px solid var(--border);padding:26px 20px;transition:all .3s;cursor:default;position:relative;overflow:hidden}
  .svc-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);transform:scaleX(0);transform-origin:left;transition:transform .3s}
  .svc-card:hover{border-color:var(--border-accent);transform:translateY(-3px);box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .svc-card:hover::before{transform:scaleX(1)}
  .svc-icon{font-size:24px;margin-bottom:14px;width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center}
  .svc-num{font-family:var(--font-m);font-size:10px;color:var(--text-3);margin-bottom:8px;letter-spacing:1px}
  .svc-t{font-size:13px;font-weight:600;margin-bottom:8px;line-height:1.3}
  .svc-d{font-size:11px;color:var(--text-3);line-height:1.5}

  /* LAYERS */
  .layers{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
  .ly-card{background:var(--bg-1);border-radius:var(--r-lg);border:1px solid var(--border);overflow:hidden;transition:all .3s}
  .ly-card:hover{border-color:var(--border-accent);transform:translateY(-2px)}
  .ly-bar{height:3px}
  .ly-1 .ly-bar{background:linear-gradient(90deg,var(--accent),transparent)}
  .ly-2 .ly-bar{background:linear-gradient(90deg,var(--gold),transparent)}
  .ly-3 .ly-bar{background:linear-gradient(90deg,var(--info),transparent)}
  .ly-hd{padding:24px 22px 18px;position:relative}
  .ly-num{font-family:var(--font-d);font-size:60px;font-weight:700;color:rgba(255,255,255,.025);position:absolute;top:8px;right:16px;line-height:1}
  .ly-tag{display:inline-flex;padding:3px 10px;border-radius:5px;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;font-family:var(--font-m)}
  .ly-1 .ly-tag{background:var(--accent-glow);color:var(--accent)}
  .ly-2 .ly-tag{background:var(--gold-dim);color:var(--gold)}
  .ly-3 .ly-tag{background:var(--info-dim);color:var(--info)}
  .ly-title{font-family:var(--font-d);font-size:19px;font-weight:700;margin-bottom:4px}
  .ly-cn{font-family:var(--font-cn);font-size:13px;color:var(--text-2)}
  .ly-desc{font-size:12px;color:var(--text-3);line-height:1.6;padding:0 22px 22px}

  /* DASHBOARD */
  .dash-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
  .dash-card{background:var(--bg-2);border-radius:var(--r-lg);border:1px solid var(--border);overflow:hidden;transition:all .3s}
  .dash-card:hover{border-color:rgba(255,255,255,.08)}
  .dash-hd{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  .dash-t{font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px}
  .dash-body{padding:18px 20px}
  .dash-row{display:flex;flex-direction:column;gap:6px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.025);font-size:12px}
  .dash-row:last-child{border-bottom:none}
  .dash-row-l{color:var(--text-2)}
  .tag{display:inline-block;padding:3px 9px;border-radius:5px;font-size:10px;font-weight:600;white-space:normal;line-height:1.4}
  .tag-pass{background:var(--success-dim);color:var(--success)}
  .tag-warn{background:var(--warn-dim);color:var(--warn)}
  .tag-fail{background:var(--danger-dim);color:var(--danger)}
  .tag-info{background:var(--info-dim);color:var(--info)}
  .risk-wrap{margin-top:8px}
  .risk-label{display:flex;justify-content:space-between;font-size:10px;color:var(--text-3);margin-bottom:4px}
  .risk-bar{height:5px;border-radius:3px;background:var(--bg-4);overflow:hidden}
  .risk-fill{height:100%;border-radius:3px;transition:width .8s ease}
  .dash-summary{padding:10px 20px 16px;font-size:11px;color:var(--text-3);line-height:1.5;border-top:1px solid var(--border);font-style:italic}
  .dash-actions{margin-top:24px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

  /* Risk Level Banner */
  .score-banner{margin-top:20px;background:var(--bg-2);border-radius:var(--r-lg);border:1px solid var(--border);padding:28px 32px;display:flex;align-items:center;gap:32px}
  .risk-level-badge{width:100px;height:100px;flex-shrink:0;border-radius:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px}
  .risk-level-badge.risk-low{background:var(--success-dim);border:2px solid var(--success)}
  .risk-level-badge.risk-medium{background:var(--warn-dim);border:2px solid var(--warn)}
  .risk-level-badge.risk-high{background:var(--danger-dim);border:2px solid var(--danger)}
  .risk-level-icon{font-size:28px;line-height:1}
  .risk-level-text{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px}
  .risk-low .risk-level-text{color:var(--success)}
  .risk-medium .risk-level-text{color:var(--warn)}
  .risk-high .risk-level-text{color:var(--danger)}
  .score-text{flex:1}
  .score-verdict{font-size:15px;font-weight:600;margin-bottom:6px}
  .score-sub{font-size:13px;color:var(--text-2);line-height:1.6}
  .rec-list{margin-top:12px;display:flex;flex-direction:column;gap:6px}
  .rec-item{font-size:12px;color:var(--text-1);display:flex;align-items:flex-start;gap:8px}
  .rec-item::before{content:'‚Üí';color:var(--accent);font-weight:700;flex-shrink:0}

  /* FDA */
  .fda-box{background:var(--bg-1);border:1px solid var(--border);border-left:4px solid var(--accent);border-radius:0 var(--r-lg) var(--r-lg) 0;padding:36px 40px;position:relative;overflow:hidden}
  .fda-box::before{content:'¬ß';position:absolute;right:30px;top:12px;font-family:var(--font-d);font-size:120px;font-weight:700;color:rgba(255,255,255,.012);line-height:1}
  .fda-title{font-family:var(--font-d);font-size:24px;font-weight:700;margin-bottom:4px}
  .fda-cn{font-family:var(--font-cn);font-size:14px;color:var(--text-2);margin-bottom:24px}
  .fda-cols{display:grid;grid-template-columns:1fr 1fr;gap:36px}
  .fda-col h4{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--accent);margin-bottom:14px;font-family:var(--font-m)}
  .fda-text{font-size:13px;color:var(--text-1);line-height:1.75}
  .fda-text p{margin-bottom:10px}
  .fda-hl{margin-top:12px;padding:14px 16px;background:var(--accent-glow2);border:1px solid rgba(45,212,168,.1);border-radius:var(--r)}
  .fda-hl-t{font-size:12px;font-weight:700;color:var(--accent);margin-bottom:8px}
  .fda-kl{list-style:none;display:flex;flex-direction:column;gap:6px}
  .fda-kl li{font-size:12px;color:var(--text-1);display:flex;align-items:center;gap:8px}
  .fda-kl li::before{content:'‚úì';color:var(--accent);font-weight:700;font-size:10px;width:18px;height:18px;border-radius:5px;background:var(--accent-glow);display:flex;align-items:center;justify-content:center;flex-shrink:0}

  /* Footer */
  footer{padding:36px var(--pad);border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;margin-top:40px}
  .footer-l{font-size:11px;color:var(--text-3)}
  .footer-r{display:flex;gap:20px}
  .footer-r a{font-size:11px;color:var(--text-3);transition:color .2s}
  .footer-r a:hover{color:var(--accent)}

  /* CN */
  .cn .hero h1{font-family:var(--font-cn);letter-spacing:0}
  .cn .sec-title,.cn .fda-title,.cn .ly-title{font-family:var(--font-cn);letter-spacing:0}
  .cn .hero-desc,.cn .sec-desc,.cn .svc-d,.cn .ly-desc,.cn .dash-row-l,.cn .fda-text,.cn .info-item,.cn .score-sub,.cn .rec-item,.cn .dash-summary{font-family:var(--font-cn)}

  /* Responsive */
  @media(max-width:1200px){.svc-grid{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:900px){.svc-grid{grid-template-columns:repeat(2,1fr)}.layers{grid-template-columns:1fr}.dash-grid{grid-template-columns:1fr}.fda-cols{grid-template-columns:1fr;gap:24px}.upload-row{grid-template-columns:1fr}.score-banner{flex-direction:column;text-align:center}}
  @media(max-width:600px){.svc-grid{grid-template-columns:1fr}.nav-r .nav-link{display:none}.fda-box{padding:24px 20px}}

  /* hide result sections initially */
  #resultsSection{display:none}
  #resultsSection.visible{display:block;animation:fu .5s ease both}

  /* Report Full-Screen Overlay */
  .report-overlay{display:none;position:fixed;inset:0;z-index:200;background:var(--bg-0);overflow-y:auto;animation:fu .3s ease both}
  .report-overlay.active{display:block}
  .report-inner{max-width:960px;margin:0 auto;padding:32px 40px 60px}
  .report-close{position:fixed;top:16px;right:24px;z-index:201;width:40px;height:40px;border-radius:10px;background:var(--bg-3);border:1px solid var(--border);color:var(--text-0);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
  .report-close:hover{background:var(--danger);border-color:var(--danger)}
  .report-header{text-align:center;padding:24px 0 32px;border-bottom:2px solid var(--border-accent);margin-bottom:32px}
  .report-brand{font-family:var(--font-d);font-size:14px;color:var(--accent);margin-bottom:8px}
  .report-title{font-family:var(--font-d);font-size:28px;font-weight:700;margin-bottom:8px}
  .report-meta{font-size:11px;color:var(--text-3);font-family:var(--font-m)}
  .report-note{margin-top:12px;padding:10px 16px;background:var(--bg-2);border:1px solid var(--border);border-radius:8px;font-size:10px;color:var(--text-3);line-height:1.5;text-align:left;display:inline-block;max-width:600px}
  /* Bigger dash card styles in overlay */
  .report-overlay .dash-card{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg)}
  .report-overlay .dash-hd{padding:18px 24px}
  .report-overlay .dash-t{font-size:16px}
  .report-overlay .dash-body{padding:20px 24px}
  .report-overlay .dash-row{padding:12px 0;font-size:14px}
  .report-overlay .dash-row-l{font-size:14px;font-weight:500;word-break:break-word}
  .report-overlay .tag{font-size:12px;padding:4px 12px;word-break:break-word}
  .report-overlay .dash-summary{font-size:13px;padding:14px 24px}
  .report-overlay .risk-label{font-size:12px}
  .report-overlay .risk-bar{height:7px}
  .report-overlay .score-banner{padding:32px 36px}
  .report-overlay .risk-level-badge{width:120px;height:120px;border-radius:24px}
  .report-overlay .risk-level-icon{font-size:36px}
  .report-overlay .risk-level-text{font-size:12px}
  .report-overlay .score-verdict{font-size:18px}
  .report-overlay .score-sub{font-size:14px}
  .report-overlay .rec-item{font-size:13px}
  /* Regulatory footnote */
  .reg-ref{display:block;font-size:10px;color:var(--text-3);font-family:var(--font-m);margin-top:3px;font-style:normal}
  .facility-note{margin-top:10px;padding:10px 14px;background:var(--info-dim);border-radius:8px;font-size:11px;color:var(--info);line-height:1.5}
  .platform-note{padding:12px 24px;font-size:10px;color:var(--text-3);line-height:1.5;border-top:1px solid var(--border);font-style:italic}

  /* Auth Modal */
  .modal-overlay{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);align-items:center;justify-content:center}
  .modal-overlay.active{display:flex}
  .modal-box{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);width:min(420px,90vw);padding:32px;position:relative;animation:fu .3s ease both}
  .modal-close{position:absolute;top:12px;right:14px;width:32px;height:32px;border-radius:8px;background:transparent;border:none;color:var(--text-2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .modal-close:hover{background:var(--bg-3);color:var(--text-0)}
  .modal-title{font-family:var(--font-d);font-size:22px;font-weight:700;margin-bottom:4px}
  .modal-sub{font-size:12px;color:var(--text-3);margin-bottom:20px}
  .modal-tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:1px solid var(--border)}
  .modal-tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:500;color:var(--text-3);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s}
  .modal-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
  .modal-form{display:none}.modal-form.active{display:block}
  .form-group{margin-bottom:14px}
  .form-group label{display:block;font-size:11px;color:var(--text-2);margin-bottom:5px;font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
  .form-input{width:100%;padding:10px 14px;background:var(--bg-2);border:1px solid var(--border);border-radius:8px;color:var(--text-0);font-size:14px;font-family:var(--font-b);outline:none;transition:border-color .2s}
  .form-input:focus{border-color:var(--accent)}
  .form-btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;margin-top:6px}
  .form-btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent-dim));color:var(--bg-0)}
  .form-btn-primary:hover{filter:brightness(1.1)}
  .form-error{color:var(--danger);font-size:11px;margin-top:8px;display:none}
  .form-error.show{display:block}

  /* User menu */
  .user-menu{display:flex;align-items:center;gap:10px}
  .user-avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-dim));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--bg-0);cursor:pointer}
  .user-name{font-size:12px;color:var(--text-1);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .user-dropdown{position:absolute;top:50px;right:var(--pad);background:var(--bg-2);border:1px solid var(--border);border-radius:12px;padding:6px;min-width:180px;display:none;z-index:101;box-shadow:0 8px 24px rgba(0,0,0,0.3)}
  .user-dropdown.open{display:block}
  .user-dd-item{padding:10px 14px;border-radius:8px;font-size:13px;color:var(--text-1);cursor:pointer;transition:background .2s;display:flex;align-items:center;gap:8px}
  .user-dd-item:hover{background:var(--bg-3)}
  .user-dd-item.danger{color:var(--danger)}

  /* Dashboard overlay */
  .dash-overlay{display:none;position:fixed;inset:0;z-index:200;background:var(--bg-0);overflow-y:auto;animation:fu .3s ease both}
  .dash-overlay.active{display:block}
  .dash-inner{max-width:900px;margin:0 auto;padding:32px 40px 60px}
  .dash-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--border)}
  .dash-header h2{font-family:var(--font-d);font-size:24px}
  .saved-reports{display:flex;flex-direction:column;gap:12px}
  .saved-card{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r);padding:16px 20px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:all .2s}
  .saved-card:hover{border-color:var(--accent);background:var(--bg-2)}
  .saved-left{flex:1}
  .saved-title{font-weight:600;font-size:14px;margin-bottom:4px}
  .saved-meta{font-size:11px;color:var(--text-3);font-family:var(--font-m)}
  .saved-score{padding:4px 10px;border-radius:8px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px}
  .saved-score.risk-low{background:var(--success-dim);color:var(--success);border:1px solid var(--success)}
  .saved-score.risk-medium{background:var(--warn-dim);color:var(--warn);border:1px solid var(--warn)}
  .saved-score.risk-high{background:var(--danger-dim);color:var(--danger);border:1px solid var(--danger)}
  .saved-actions{display:flex;gap:8px;margin-left:12px}
  .saved-del{width:32px;height:32px;border-radius:8px;background:transparent;border:1px solid var(--border);color:var(--text-3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .2s}
  .saved-del:hover{border-color:var(--danger);color:var(--danger);background:var(--danger-dim)}
  .empty-state{text-align:center;padding:60px 20px;color:var(--text-3)}
  .empty-state .empty-icon{font-size:48px;margin-bottom:12px}
  .empty-state p{font-size:14px}

  /* Step Indicator */
  .step-indicator{display:flex;align-items:center;justify-content:center;gap:0;margin-bottom:28px}
  .step{display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:10px;font-size:12px;font-weight:500;color:var(--text-3);transition:all .3s}
  .step.active{color:var(--accent);background:var(--accent-glow)}
  .step.done{color:var(--success);background:var(--success-dim)}
  .step-num{width:24px;height:24px;border-radius:50%;background:var(--bg-4);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;font-family:var(--font-m);transition:all .3s}
  .step.active .step-num{background:var(--accent);color:var(--bg-0)}
  .step.done .step-num{background:var(--success);color:var(--bg-0)}
  .step-line{width:40px;height:2px;background:var(--bg-4);flex-shrink:0}

  /* Extract Overlay */
  .extract-overlay{display:none;position:fixed;inset:0;z-index:200;background:var(--bg-0);overflow-y:auto;animation:fu .3s ease both}
  .extract-overlay.active{display:block}
  .extract-inner{max-width:900px;margin:0 auto;padding:32px 40px 60px}
  .extract-section{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:24px;margin-bottom:16px}
  .extract-section-title{font-size:15px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;gap:8px}
  .extract-section.highlight{border-left:3px solid var(--accent)}

  /* Editable fields */
  .ext-input{width:100%;padding:9px 14px;background:var(--bg-2);border:1px solid var(--border);border-radius:8px;color:var(--text-0);font-size:13px;font-family:var(--font-b);outline:none;transition:border-color .2s}
  .ext-input:focus{border-color:var(--accent)}
  .ext-input::placeholder{color:var(--text-3)}
  .ext-input-sm{width:100px;padding:8px 10px;background:var(--bg-2);border:1px solid var(--border);border-radius:8px;color:var(--text-0);font-size:12px;font-family:var(--font-b);outline:none;transition:border-color .2s}
  .ext-input-sm:focus{border-color:var(--accent)}
  .ext-input-sm::placeholder{color:var(--text-3)}
  .field-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:600px){.field-grid{grid-template-columns:1fr}}
  .field-group{display:flex;flex-direction:column;gap:5px}
  .field-group label{font-size:11px;color:var(--text-2);font-weight:500;text-transform:uppercase;letter-spacing:0.5px}

  /* Ingredient/Nutrition rows */
  .ext-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)}
  .ext-row:last-child{border-bottom:none}
  .ext-row .ext-input{flex:1}
  .ext-row .ext-input-sm{flex-shrink:0}
  .ext-row-num{width:24px;font-size:11px;color:var(--text-3);font-family:var(--font-m);flex-shrink:0;text-align:center}
  .ext-remove{width:28px;height:28px;border-radius:6px;background:transparent;border:1px solid var(--border);color:var(--text-3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;transition:all .2s}
  .ext-remove:hover{border-color:var(--danger);color:var(--danger);background:var(--danger-dim)}

  /* Allergen tags */
  .allergen-tags{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .allergen-tag{display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:var(--warn-dim);color:var(--warn);font-size:12px;font-weight:500}
  .allergen-tag button{background:none;border:none;color:var(--warn);cursor:pointer;font-size:10px;padding:0 2px}
  .allergen-tag button:hover{color:var(--danger)}
  .allergen-add{display:flex;gap:6px;align-items:center}
  .allergen-add input{width:120px}

  /* FDA status selectors */
  .fda-status-group{margin-bottom:16px}
  .fda-status-label{display:block;font-size:13px;font-weight:600;color:var(--text-1);margin-bottom:8px}
  .fda-radio-row{display:flex;flex-wrap:wrap;gap:8px}
  .fda-radio{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:8px;background:var(--bg-2);border:1px solid var(--border);cursor:pointer;font-size:12px;color:var(--text-2);transition:all .2s}
  .fda-radio:hover{border-color:var(--accent);color:var(--text-1)}
  .fda-radio input[type="radio"]{accent-color:var(--accent);cursor:pointer;margin:0}
  .fda-radio:has(input:checked){border-color:var(--accent);background:rgba(13,147,115,.1);color:var(--text-1)}
  .fda-optional-id{margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
  @media(max-width:600px){.fda-radio-row{flex-direction:column}}

  /* Confirm bar */
  .confirm-bar{background:var(--bg-1);border:1px solid var(--border-accent);border-radius:var(--r-lg);padding:24px 32px;display:flex;align-items:center;justify-content:center;gap:20px;margin-top:24px}
  .confirm-check{display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px;color:var(--text-1)}
  .confirm-check input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent);cursor:pointer}
  .btn-lg{padding:14px 32px;font-size:14px;border-radius:12px}
  @media(max-width:600px){.confirm-bar{flex-direction:column;gap:12px;padding:12px 16px}}
</style>
</head>
<body id="app">
<svg style="position:absolute;width:0;height:0"><defs><linearGradient id="sg" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#2DD4A8"/><stop offset="100%" stop-color="#60A5FA"/></linearGradient></defs></svg>

<!-- NAV -->
<nav>
  <div class="nav-brand">
    <div class="nav-logo">GT</div>
    <div class="nav-name">GoTo<em>Market</em></div>
  </div>
  <div class="nav-r">
    <span class="nav-link active" onclick="sTo('hero')" data-en="Home" data-cn="È¶ñÈ°µ">Home</span>
    <span class="nav-link" onclick="sTo('services')" data-en="Services" data-cn="ÊúçÂä°">Services</span>
    <span class="nav-link" onclick="sTo('layers')" data-en="Model" data-cn="ÊúçÂä°Ê®°Âûã">Model</span>
    <span class="nav-link" onclick="sTo('dashboard')" data-en="Report" data-cn="Êä•Âëä">Report</span>
    <span class="nav-link" onclick="sTo('fda')" data-en="Regulatory" data-cn="Ê≥ïËßÑËØ¥Êòé">Regulatory</span>
    <div class="lang-sw">
      <button class="lang-btn" id="lEn" onclick="setLang('en')">EN</button>
      <button class="lang-btn active" id="lCn" onclick="setLang('cn')">‰∏≠Êñá</button>
    </div>
    <!-- Auth: logged out -->
    <div id="authBtns" style="display:flex;gap:8px">
      <button class="btn btn-ghost btn-sm" onclick="openAuthModal('login')" style="padding:6px 14px;font-size:12px" data-en="Log In" data-cn="ÁôªÂΩï">Log In</button>
      <button class="btn btn-accent btn-sm" onclick="openAuthModal('register')" style="padding:6px 14px;font-size:12px" data-en="Sign Up" data-cn="Ê≥®ÂÜå">Sign Up</button>
    </div>
    <!-- Auth: logged in -->
    <div id="userMenu" class="user-menu" style="display:none">
      <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()"></div>
      <span class="user-name" id="userName"></span>
    </div>
    <div class="user-dropdown" id="userDropdown">
      <div class="user-dd-item" onclick="openDashboard()">üìã <span data-en="My Reports" data-cn="ÊàëÁöÑÊä•Âëä">My Reports</span></div>
      <div class="user-dd-item danger" onclick="doLogout()">üö™ <span data-en="Log Out" data-cn="ÈÄÄÂá∫ÁôªÂΩï">Log Out</span></div>
    </div>
  </div>
</nav>

<!-- HERO -->
<section class="hero" id="hero">
  <div class="hero-orb hero-orb-1"></div>
  <div class="hero-orb hero-orb-2"></div>
  <div class="hero-grid"></div>
  <div class="hero-inner">
    <div class="hero-badge" data-en="Product Compliance & Market Entry Architecture Platform" data-cn="‰∫ßÂìÅÂêàËßÑ‰∏éÂ∏ÇÂú∫ÂáÜÂÖ•Êû∂ÊûÑÂπ≥Âè∞">Product Compliance & Market Entry Architecture Platform</div>
    <h1 data-en='Product <em>Compliance and Market Entry</em> Assessment' data-cn='‰∫ßÂìÅ<em>ÂêàËßÑ‰∏éÂ∏ÇÂú∫ÂáÜÂÖ•</em>ËØÑ‰º∞'>‰∫ßÂìÅ<em>ÂêàËßÑ‰∏éÂ∏ÇÂú∫ÂáÜÂÖ•</em>ËØÑ‰º∞</h1>
    <p class="hero-desc" data-en="U.S. Food & Supplement Regulatory Compliance Analysis" data-cn="ÁæéÂõΩÈ£üÂìÅ‰∏éËÜ≥È£üË°•ÂÖÖÂâÇÊ≥ïËßÑÂêàËßÑÂàÜÊûê">ÁæéÂõΩÈ£üÂìÅ‰∏éËÜ≥È£üË°•ÂÖÖÂâÇÊ≥ïËßÑÂêàËßÑÂàÜÊûê</p>
    <div class="hero-actions">
      <button class="btn btn-accent" onclick="sTo('uploadArea')" data-en="‚ö° Start Structural Assessment" data-cn="‚ö° ÂºÄÂßãÁªìÊûÑËØÑ‰º∞">‚ö° Start Structural Assessment</button>
      <button class="btn btn-ghost" onclick="document.getElementById('fInput').click()" data-en="üìé Upload Product Files" data-cn="üìé ‰∏ä‰º†‰∫ßÂìÅËµÑÊñô">üìé Upload Product Files</button>
    </div>
    <!-- /hero-actions -->
  </div>
  <!-- /hero-inner ‚Äî upload lives outside to get full width -->

  <!-- Step Indicator -->
  <div class="step-indicator" id="stepIndicator" style="display:none">
    <div class="step active" id="step1">
      <div class="step-num">1</div>
      <span data-en="Upload" data-cn="‰∏ä‰º†">Upload</span>
    </div>
    <div class="step-line"></div>
    <div class="step" id="step2">
      <div class="step-num">2</div>
      <span data-en="Review & Edit" data-cn="ÂÆ°Ê†∏ÁºñËæë">Review & Edit</span>
    </div>
    <div class="step-line"></div>
    <div class="step" id="step3">
      <div class="step-num">3</div>
      <span data-en="Report" data-cn="Êä•Âëä">Report</span>
    </div>
  </div>

  <!-- Upload -->
  <div class="upload-row" id="uploadArea">
    <div class="upload-zone" id="upZone" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleDrop(event)" onclick="document.getElementById('fInput').click()">
      <input type="file" id="fInput" accept="image/jpeg,image/png,image/webp,application/pdf" multiple style="display:none" onchange="handleFiles(this.files)">
      <div class="upload-icon-wrap" id="upIcon">üì¶</div>
      <div class="upload-title" data-en="Drop product files here" data-cn="ÊãñÊîæ‰∫ßÂìÅËµÑÊñôÂà∞Ê≠§Â§Ñ">Drop product files here</div>
      <div class="upload-desc" data-en="Supports multiple files ¬∑ packaging photos, labels, ingredients" data-cn="ÊîØÊåÅÂ§öÊñá‰ª∂‰∏ä‰º† ¬∑ ÂåÖË£ÖÁÖßÁâá„ÄÅÊ†áÁ≠æ„ÄÅÈÖçÊñôË°®">Supports multiple files ¬∑ packaging photos, labels, ingredients</div>
      <div class="upload-formats"><span class="fmt">JPG</span><span class="fmt">PNG</span><span class="fmt">PDF</span><span class="fmt">MULTI</span></div>
      <div class="file-list" id="fileList"></div>
    </div>
    <div class="upload-info">
      <div class="info-title" data-en="üìã Assessment Dimensions" data-cn="üìã Êä•ÂëäËØÑ‰º∞Áª¥Â∫¶">üìã Assessment Dimensions</div>
      <div class="info-list">
        <div class="info-item"><div class="info-dot" style="background:var(--accent-glow)">üß™</div><div><div class="iit-t" data-en="Ingredient Compliance Analysis" data-cn="ÊàêÂàÜÂêàËßÑÁªìÊûÑÂàÜÊûê">Ingredient Compliance Analysis</div><div class="iit-d" data-en="Structural analysis of ingredient legality & GRAS status" data-cn="ÊàêÂàÜÂêàÊ≥ïÊÄß‰∏éGRASÁä∂ÊÄÅÁªìÊûÑÂàÜÊûê">Structural analysis of ingredient legality & GRAS status</div></div></div>
        <div class="info-item"><div class="info-dot" style="background:var(--gold-dim)">üè∑Ô∏è</div><div><div class="iit-t" data-en="Label Architecture Review" data-cn="Ê†áÁ≠æÂêàËßÑÊû∂ÊûÑÂÆ°Êü•">Label Architecture Review</div><div class="iit-d" data-en="Nutrition facts, allergens, labeling structure" data-cn="Ëê•ÂÖªÊàêÂàÜË°®„ÄÅËøáÊïèÂéü„ÄÅÊ†áÁ≠æÊû∂ÊûÑ">Nutrition facts, allergens, labeling structure</div></div></div>
        <div class="info-item"><div class="info-dot" style="background:var(--info-dim)">üè≠</div><div><div class="iit-t" data-en="Facility Registration Verification" data-cn="Áîü‰∫ßËÆæÊñΩÊ≥®ÂÜåÁä∂ÊÄÅÊ†∏Êü•">Facility Registration Verification</div><div class="iit-d" data-en="Manufacturing facility registration status" data-cn="Áîü‰∫ßËÆæÊñΩÊ≥®ÂÜåÁä∂ÊÄÅÊ†∏Êü•">Manufacturing facility registration status</div></div></div>
        <div class="info-item"><div class="info-dot" style="background:var(--warn-dim)">‚öñÔ∏è</div><div><div class="iit-t" data-en="Marketing Claims Risk Identification" data-cn="ÂÆ£‰º†ËØ≠Ê≥ïËßÑÈ£éÈô©ËØÜÂà´">Marketing Claims Risk Identification</div><div class="iit-d" data-en="Regulatory risk in promotional language" data-cn="ÂÆ£‰º†ËØ≠Ë®ÄÊ≥ïËßÑÈ£éÈô©ËØÜÂà´">Regulatory risk in promotional language</div></div></div>
        <div class="info-item"><div class="info-dot" style="background:var(--success-dim)">üöÄ</div><div><div class="iit-t" data-en="Market Entry Readiness" data-cn="Â∏ÇÂú∫ÂáÜÂÖ•ÂáÜÂ§áÂ∫¶ËØÑ‰º∞">Market Entry Readiness</div><div class="iit-d" data-en="Overall market entry preparedness" data-cn="Â∏ÇÂú∫ÂáÜÂÖ•Êï¥‰ΩìÂáÜÂ§áÂ∫¶ËØÑ‰º∞">Overall market entry preparedness</div></div></div>
      </div>
    </div>
  </div>

  <!-- Analyze Bar -->
  <div class="analyze-bar" id="analyzeBar" style="display:none">
    <button class="btn btn-accent" id="analyzeBtn" onclick="startAnalysis()">
      <span data-en="üîç Extract Product Info" data-cn="üîç AI ËØÜÂà´‰∫ßÂìÅ‰ø°ÊÅØ">üîç Extract Product Info</span>
    </button>
    <span class="analyze-status" id="analyzeStatus"></span>
  </div>
</section>

<div class="divider"></div>

<!-- CORE SERVICES -->
<section class="section" id="services">
  <div class="sec-label" data-en="Assessment Dimensions" data-cn="ËØÑ‰º∞Áª¥Â∫¶">Assessment Dimensions</div>
  <div class="sec-title" data-en="Report Assessment Dimensions" data-cn="Êä•ÂëäËØÑ‰º∞Áª¥Â∫¶">Report Assessment Dimensions</div>
  <div class="sec-desc" data-en="Five analytical dimensions covering the structural compliance of your product." data-cn="‰∫î‰∏™ÂàÜÊûêÁª¥Â∫¶ÔºåÂÖ®Èù¢Ë¶ÜÁõñ‰∫ßÂìÅÁöÑÁªìÊûÑÊÄßÂêàËßÑËØÑ‰º∞„ÄÇ">Five analytical dimensions covering the structural compliance of your product.</div>
  <div class="svc-grid">
    <div class="svc-card"><div class="svc-icon" style="background:var(--accent-glow)">üß™</div><div class="svc-num">01</div><div class="svc-t" data-en="Ingredient Compliance Structural Analysis" data-cn="ÊàêÂàÜÂêàËßÑÁªìÊûÑÂàÜÊûê">Ingredient Compliance Structural Analysis</div><div class="svc-d" data-en="Structural analysis of ingredient legality, GRAS status, and dietary supplement regulatory compliance." data-cn="ÊàêÂàÜÂêàÊ≥ïÊÄß„ÄÅGRASÁä∂ÊÄÅÂèäËÜ≥È£üË°•ÂÖÖÂâÇÊ≥ïËßÑÂêàËßÑÁöÑÁªìÊûÑÂàÜÊûê„ÄÇ">Structural analysis of ingredient legality, GRAS status, and dietary supplement regulatory compliance.</div></div>
    <div class="svc-card"><div class="svc-icon" style="background:var(--gold-dim)">üè∑Ô∏è</div><div class="svc-num">02</div><div class="svc-t" data-en="Label Compliance Architecture Review" data-cn="Ê†áÁ≠æÂêàËßÑÊû∂ÊûÑÂÆ°Êü•">Label Compliance Architecture Review</div><div class="svc-d" data-en="Structural review of nutrition facts, allergen declarations, and labeling regulatory requirements." data-cn="Ëê•ÂÖªÊàêÂàÜË°®„ÄÅËøáÊïèÂéüÂ£∞ÊòéÂèäÊ†áÁ≠æÊ≥ïËßÑË¶ÅÊ±ÇÁöÑÊû∂ÊûÑÂÆ°Êü•„ÄÇ">Structural review of nutrition facts, allergen declarations, and labeling regulatory requirements.</div></div>
    <div class="svc-card"><div class="svc-icon" style="background:var(--info-dim)">üè≠</div><div class="svc-num">03</div><div class="svc-t" data-en="Facility Registration Verification" data-cn="Áîü‰∫ßËÆæÊñΩÊ≥®ÂÜåÁä∂ÊÄÅÊ†∏Êü•">Facility Registration Verification</div><div class="svc-d" data-en="Verification of manufacturing facility registration status, US Agent designation, and FSVP compliance." data-cn="Áîü‰∫ßËÆæÊñΩÊ≥®ÂÜåÁä∂ÊÄÅ„ÄÅÁæéÂõΩ‰ª£ÁêÜ‰∫∫ÊåáÂÆöÂèäFSVPÂêàËßÑÊ†∏Êü•„ÄÇ">Verification of manufacturing facility registration status, US Agent designation, and FSVP compliance.</div></div>
    <div class="svc-card"><div class="svc-icon" style="background:var(--warn-dim)">‚öñÔ∏è</div><div class="svc-num">04</div><div class="svc-t" data-en="Marketing Claims Risk Identification" data-cn="ÂÆ£‰º†ËØ≠Ê≥ïËßÑÈ£éÈô©ËØÜÂà´">Marketing Claims Risk Identification</div><div class="svc-d" data-en="Identification of regulatory risks in product marketing claims and promotional language." data-cn="‰∫ßÂìÅÂÆ£‰º†ËØ≠Ë®ÄÂèäËê•ÈîÄË°®Ëø∞ÁöÑÊ≥ïËßÑÈ£éÈô©ËØÜÂà´„ÄÇ">Identification of regulatory risks in product marketing claims and promotional language.</div></div>
    <div class="svc-card"><div class="svc-icon" style="background:var(--success-dim)">üöÄ</div><div class="svc-num">05</div><div class="svc-t" data-en="Market Entry Readiness Assessment" data-cn="Â∏ÇÂú∫ÂáÜÂÖ•ÂáÜÂ§áÂ∫¶ËØÑ‰º∞">Market Entry Readiness Assessment</div><div class="svc-d" data-en="Assessment of overall readiness for U.S. market entry and regulatory preparedness." data-cn="ÁæéÂõΩÂ∏ÇÂú∫ÂáÜÂÖ•ÁöÑÊï¥‰ΩìÂáÜÂ§áÂ∫¶‰∏éÊ≥ïËßÑÂ∞±Áª™ÊÄßËØÑ‰º∞„ÄÇ">Assessment of overall readiness for U.S. market entry and regulatory preparedness.</div></div>
  </div>
</section>

<div class="divider"></div>

<!-- LAYERED MODEL -->
<section class="section" id="layers">
  <div class="sec-label" data-en="Service Delivery" data-cn="ÊúçÂä°‰∫§‰ªò">Service Delivery</div>
  <div class="sec-title" data-en="Three-Layer Service Delivery Model" data-cn="‰∏âÂ±ÇÊúçÂä°‰∫§‰ªòÁªìÊûÑ">Three-Layer Service Delivery Model</div>
  <div class="sec-desc" data-en="How we deliver compliance assessment services, from automated screening to expert support." data-cn="‰ªéËá™Âä®ÂåñÁ≠õÊü•Âà∞‰∏ìÂÆ∂ÊîØÊåÅÔºåÊàë‰ª¨Â¶Ç‰Ωï‰∫§‰ªòÂêàËßÑËØÑ‰º∞ÊúçÂä°„ÄÇ">How we deliver compliance assessment services, from automated screening to expert support.</div>
  <div class="layers">
    <div class="ly-card ly-1"><div class="ly-bar"></div><div class="ly-hd"><div class="ly-num">01</div><div class="ly-tag" data-en="Layer 1" data-cn="Á¨¨‰∏ÄÂ±Ç">Layer 1</div><div class="ly-title" data-en="AI Structural Screening" data-cn="AIÁªìÊûÑÁ≠õÊü•">AI Structural Screening</div><div class="ly-cn" data-en="Automated Compliance Risk Identification" data-cn="Ëá™Âä®ÂåñÂêàËßÑÈ£éÈô©ËØÜÂà´">Automated Compliance Risk Identification</div></div><div class="ly-desc" data-en="AI-powered structural risk identification. Automated ingredient analysis, label format review, and preliminary compliance structure assessment." data-cn="AIÈ©±Âä®ÁöÑÁªìÊûÑÈ£éÈô©ËØÜÂà´„ÄÇËá™Âä®ÂåñÊàêÂàÜÂàÜÊûê„ÄÅÊ†áÁ≠æÊ†ºÂºèÂÆ°Êü•ÂíåÂàùÊ≠•ÂêàËßÑÁªìÊûÑËØÑ‰º∞„ÄÇ">AI-powered structural risk identification. Automated ingredient analysis, label format review, and preliminary compliance structure assessment.</div></div>
    <div class="ly-card ly-2"><div class="ly-bar"></div><div class="ly-hd"><div class="ly-num">02</div><div class="ly-tag" data-en="Layer 2" data-cn="Á¨¨‰∫åÂ±Ç">Layer 2</div><div class="ly-title" data-en="Expert Compliance Optimization" data-cn="‰∏ìÂÆ∂ÂêàËßÑ‰ºòÂåñ">Expert Compliance Optimization</div><div class="ly-cn" data-en="Professional Compliance Structure Review" data-cn="‰∏ì‰∏öÂêàËßÑÁªìÊûÑÂÆ°Êü•">Professional Compliance Structure Review</div></div><div class="ly-desc" data-en="Expert review of compliance structure, ingredient declarations, label architecture, and marketing language optimization." data-cn="‰∏ìÂÆ∂ÂÆ°Êü•ÂêàËßÑÁªìÊûÑ„ÄÅÊàêÂàÜÂ£∞Êòé„ÄÅÊ†áÁ≠æÊû∂ÊûÑÂèäÂÆ£‰º†ËØ≠Ë®Ä‰ºòÂåñ„ÄÇ">Expert review of compliance structure, ingredient declarations, label architecture, and marketing language optimization.</div></div>
    <div class="ly-card ly-3"><div class="ly-bar"></div><div class="ly-hd"><div class="ly-num">03</div><div class="ly-tag" data-en="Layer 3" data-cn="Á¨¨‰∏âÂ±Ç">Layer 3</div><div class="ly-title" data-en="Legal & Market Entry Support" data-cn="Ê≥ïÂä°‰∏éÂ∏ÇÂú∫ÂáÜÂÖ•ÊîØÊåÅ">Legal & Market Entry Support</div><div class="ly-cn" data-en="Regulatory Counsel & Market Access Planning" data-cn="Ê≥ïËßÑÈ°æÈóÆÂØπÊé• ¬∑ Â∏ÇÂú∫ÂáÜÂÖ•ËßÑÂàí">Regulatory Counsel & Market Access Planning</div></div><div class="ly-desc" data-en="Regulatory counsel engagement, market entry strategy, and compliance framework design for sustainable market access." data-cn="Ê≥ïËßÑÈ°æÈóÆÂØπÊé•„ÄÅÂ∏ÇÂú∫ÂáÜÂÖ•Á≠ñÁï•ÂèäÂêàËßÑÊ°ÜÊû∂ËÆæËÆ°ÔºåÊîØÊåÅÂèØÊåÅÁª≠ÁöÑÂ∏ÇÂú∫ËøõÂÖ•„ÄÇ">Regulatory counsel engagement, market entry strategy, and compliance framework design for sustainable market access.</div></div>
  </div>
</section>

<div class="divider"></div>

<!-- DASHBOARD / REPORT -->
<section class="section" id="dashboard">
  <div class="sec-label" data-en="Structural Assessment" data-cn="ÁªìÊûÑËØÑ‰º∞">Structural Assessment</div>
  <div class="sec-title" data-en="Product Compliance Structural Assessment" data-cn="‰∫ßÂìÅÂêàËßÑÁªìÊûÑËØÑ‰º∞">Product Compliance Structural Assessment</div>
  <div class="sec-desc" data-en="Upload product files for AI-powered structural compliance analysis. Full report opens in a dedicated view." data-cn="‰∏ä‰º†‰∫ßÂìÅËµÑÊñôËøõË°å AI ÂêàËßÑÁªìÊûÑÂàÜÊûê„ÄÇÂÆåÊï¥Êä•ÂëäÂ∞ÜÂú®Áã¨Á´ãÈ°µÈù¢Â±ïÁ§∫„ÄÇ">Upload product files for AI-powered structural compliance analysis. Full report opens in a dedicated view.</div>

  <!-- Dynamic results rendered here -->
  <div id="reportContent">
    <!-- Default demo content -->
    <div class="dash-grid">
      <div class="dash-card"><div class="dash-hd"><span class="dash-t">üß™ <span data-en="Ingredient Compliance Analysis" data-cn="ÊàêÂàÜÂêàËßÑÁªìÊûÑÂàÜÊûê">Ingredient Compliance Analysis</span></span><span class="tag tag-warn" data-en="3 Flags" data-cn="3 È°πÊ†áËÆ∞">3 Flags</span></div><div class="dash-body"><div class="dash-row"><span class="dash-row-l" data-en="Sodium Benzoate (E211)" data-cn="ËãØÁî≤ÈÖ∏Èí† (E211)">Sodium Benzoate (E211)</span><span class="tag tag-pass">GRAS</span></div><div class="dash-row"><span class="dash-row-l" data-en="Red No. 40 (Allura Red)" data-cn="ËØ±ÊÉëÁ∫¢40Âè∑">Red No. 40 (Allura Red)</span><span class="tag tag-warn" data-en="Requires Listing" data-cn="ÈúÄÊ†áÊ≥®">Requires Listing</span></div><div class="dash-row"><span class="dash-row-l" data-en="Steviol Glycosides" data-cn="ÁîúËèäÁ≥ñËã∑">Steviol Glycosides</span><span class="tag tag-pass">GRAS</span></div><div class="dash-row"><span class="dash-row-l" data-en="Titanium Dioxide (E171)" data-cn="‰∫åÊ∞ßÂåñÈíõ (E171)">Titanium Dioxide (E171)</span><span class="tag tag-warn" data-en="Requires Review" data-cn="ÈúÄÂÆ°Êü•">Requires Review</span></div><div class="risk-wrap"><div class="risk-label"><span data-en="Risk Level" data-cn="È£éÈô©Á≠âÁ∫ß">Risk Level</span><span data-en="Medium" data-cn="‰∏≠Á≠â">Medium</span></div><div class="risk-bar"><div class="risk-fill" style="width:55%;background:linear-gradient(90deg,var(--success),var(--warn))"></div></div></div></div></div>
      <div class="dash-card"><div class="dash-hd"><span class="dash-t">üè∑Ô∏è <span data-en="Label Architecture Review" data-cn="Ê†áÁ≠æÂêàËßÑÊû∂ÊûÑÂÆ°Êü•">Label Architecture Review</span></span><span class="tag tag-pass">7/9</span></div><div class="dash-body"><div class="dash-row"><span class="dash-row-l" data-en="Nutrition Facts (2020)" data-cn="Ëê•ÂÖªÊàêÂàÜË°® (2020)">Nutrition Facts (2020)</span><span class="tag tag-pass" data-en="Pass" data-cn="ÈÄöËøá">Pass</span></div><div class="dash-row"><span class="dash-row-l" data-en="Allergen Declaration" data-cn="ËøáÊïèÂéüÂ£∞Êòé">Allergen Declaration</span><span class="tag tag-warn" data-en="Review" data-cn="ÂæÖÂÆ°Êü•">Review</span></div><div class="dash-row"><span class="dash-row-l" data-en="Net Weight (Dual)" data-cn="ÂáÄÂê´ÈáèÔºàÂèåÂçï‰ΩçÔºâ">Net Weight (Dual)</span><span class="tag tag-warn" data-en="Needs Optimization" data-cn="ÈúÄ‰ºòÂåñ">Needs Optimization</span></div><div class="dash-row"><span class="dash-row-l" data-en="Country of Origin" data-cn="Âéü‰∫ßÂõΩ">Country of Origin</span><span class="tag tag-pass" data-en="Pass" data-cn="ÈÄöËøá">Pass</span></div></div></div>
      <div class="dash-card"><div class="dash-hd"><span class="dash-t">üè≠ <span data-en="Facility Registration Verification" data-cn="Áîü‰∫ßËÆæÊñΩÊ≥®ÂÜåÊ†∏Êü•">Facility Registration Verification</span></span><span class="tag tag-info" data-en="Pending Verification" data-cn="ÂæÖÊ†∏È™å">Pending Verification</span></div><div class="dash-body"><div class="dash-row"><span class="dash-row-l" data-en="FDA Facility (FEI)" data-cn="FDA ËÆæÊñΩÁºñÂè∑ (FEI)">FDA Facility (FEI)</span><span class="tag tag-info" data-en="Verify with facility" data-cn="ÈúÄ‰∏éÂ∑•ÂéÇÁ°ÆËÆ§">Verify with facility</span></div><div class="dash-row"><span class="dash-row-l" data-en="DUNS Number" data-cn="DUNS ÁºñÂè∑">DUNS Number</span><span class="tag tag-info" data-en="Verify with facility" data-cn="ÈúÄ‰∏éÂ∑•ÂéÇÁ°ÆËÆ§">Verify with facility</span></div><div class="dash-row"><span class="dash-row-l" data-en="FSVP Importer" data-cn="FSVP ËøõÂè£ÂïÜ">FSVP Importer</span><span class="tag tag-warn" data-en="Pending" data-cn="ÂæÖÁ°ÆËÆ§">Pending</span></div><div style="margin-top:8px;padding:8px 10px;background:var(--info-dim);border-radius:8px;font-size:10px;color:var(--info);line-height:1.5" data-en="Note: Facility FEI/DUNS information must be confirmed with the manufacturer and verified as currently active." data-cn="Ê≥®ÔºöÈúÄ‰∏éÂ∑•ÂéÇÁ°ÆËÆ§ÊòØÂê¶ÊåÅÊúâËÆæÊñΩ FEI Êàñ DUNS ÁºñÂè∑ÔºåÂπ∂Á°Æ‰øùÂú®ÊúâÊïàÊúüÂÜÖ„ÄÇ">Note: Facility FEI/DUNS information must be confirmed with the manufacturer and verified as currently active.</div></div><div class="dash-summary" data-en="This platform does not directly access FDA internal databases. Verification is based on publicly available information and client-provided documentation." data-cn="Êú¨Âπ≥Âè∞‰∏çÁõ¥Êé•ËÆøÈóÆ FDA ÂÜÖÈÉ®Êï∞ÊçÆÂ∫ìÔºå‰ªÖÂü∫‰∫éÂÖ¨ÂºÄ‰ø°ÊÅØ‰∏éÂÆ¢Êà∑Êèê‰æõËµÑÊñôËøõË°åÊ†∏Êü•„ÄÇ">This platform does not directly access FDA internal databases. Verification is based on publicly available information and client-provided documentation.</div></div>
      <div class="dash-card"><div class="dash-hd"><span class="dash-t">üí¨ <span data-en="Marketing Claims Risk" data-cn="ÂÆ£‰º†ËØ≠Ê≥ïËßÑÈ£éÈô©">Marketing Claims Risk</span></span><span class="tag tag-warn" data-en="2 Items" data-cn="2 È°πÂæÖÂÆ°">2 Items</span></div><div class="dash-body"><div class="dash-row"><span class="dash-row-l">"All Natural"</span><span class="tag tag-warn" data-en="Needs Review" data-cn="ÈúÄÂÆ°Êü•">Needs Review</span></div><div class="dash-row"><span class="dash-row-l">"Boosts Immunity"</span><span class="tag tag-warn" data-en="Requires Assessment" data-cn="ÈúÄËØÑ‰º∞">Requires Assessment</span></div><div class="dash-row"><span class="dash-row-l">"Low Sugar"</span><span class="tag tag-pass" data-en="Compliant" data-cn="ÂêàËßÑ">Compliant</span></div><div class="risk-wrap"><div class="risk-label"><span data-en="Structural Risk" data-cn="ÁªìÊûÑÈ£éÈô©">Structural Risk</span><span data-en="Medium-High" data-cn="‰∏≠È´ò">Medium-High</span></div><div class="risk-bar"><div class="risk-fill" style="width:65%;background:linear-gradient(90deg,var(--warn),var(--danger))"></div></div></div></div></div>
    </div>
    <div class="dash-actions">
      <button class="btn btn-accent btn-sm" onclick="requestConsult()" data-en="üí¨ Request Expert Consultation" data-cn="üí¨ Áî≥ËØ∑‰∫∫Â∑•Âí®ËØ¢" style="background:linear-gradient(135deg,var(--accent),var(--accent-dim))">üí¨ Request Expert Consultation</button>
      <button class="btn btn-ghost btn-sm" onclick="exportPDF()" data-en="‚¨á Export PDF Report" data-cn="‚¨á ÂØºÂá∫ PDF Êä•Âëä">‚¨á Export PDF Report</button>
    </div>
  </div>
</section>

<div class="divider"></div>

<!-- FDA DISCLAIMER -->
<section class="section" id="fda" style="padding-bottom:40px">
  <div class="fda-box">
    <div class="fda-title" data-en="Regulatory Framework" data-cn="Ê≥ïËßÑÊ°ÜÊû∂ËØ¥Êòé">Regulatory Framework</div>
    <div class="fda-cn" data-en="Key regulatory context for food and dietary supplement products" data-cn="È£üÂìÅÂèäËÜ≥È£üË°•ÂÖÖÂâÇ‰∫ßÂìÅÁöÑÂÖ≥ÈîÆÊ≥ïËßÑËÉåÊôØ">Key regulatory context for food and dietary supplement products</div>
    <div class="fda-text" data-en="<p>For food and dietary supplement products, the U.S. FDA <strong style='color:var(--accent)'>does not approve individual products</strong>. There is no product-level certification or approval process for these categories.</p><p>FDA registration applies to <strong>manufacturing facilities</strong>. The regulatory focus is on the production site, not on individual product SKUs or brand names.</p><p>Product compliance is determined by <strong>ingredient legality, proper labeling structure, and valid facility registration status</strong>. These are the structural elements that define market entry readiness.</p>" data-cn="<p>ÂØπ‰∫éÈ£üÂìÅÂèäËÜ≥È£üË°•ÂÖÖÂâÇ‰∫ßÂìÅÔºåÁæéÂõΩFDA<strong style='color:var(--accent)'>‰∏çÂØπÂçïÂìÅËøõË°åÂÆ°Êâπ</strong>„ÄÇÊ≠§Á±ª‰∫ßÂìÅ‰∏çÂ≠òÂú®‰∫ßÂìÅÂ±ÇÈù¢ÁöÑËÆ§ËØÅÊàñÊâπÂáÜÊµÅÁ®ã„ÄÇ</p><p>FDAÊ≥®ÂÜåÂØπË±°‰∏∫<strong>Áîü‰∫ßËÆæÊñΩ</strong>„ÄÇÁõëÁÆ°ÈáçÁÇπÂú®‰∫éÁîü‰∫ßÂú∫ÊâÄÔºåËÄåÈùûÂçï‰∏™‰∫ßÂìÅÊàñÂìÅÁâå„ÄÇ</p><p>‰∫ßÂìÅÂêàËßÑÂèñÂÜ≥‰∫é<strong>ÊàêÂàÜÂêàÊ≥ïÊÄß„ÄÅÊ†áÁ≠æÁªìÊûÑËßÑËåÉ‰ª•ÂèäËÆæÊñΩÊ≥®ÂÜåÊúâÊïàÊÄß</strong>„ÄÇËøô‰∫õÊòØÂÜ≥ÂÆöÂ∏ÇÂú∫ÂáÜÂÖ•Â∞±Áª™Â∫¶ÁöÑÁªìÊûÑÊÄßË¶ÅÁ¥†„ÄÇ</p>">
      <p>For food and dietary supplement products, the U.S. FDA <strong style="color:var(--accent)">does not approve individual products</strong>. There is no product-level certification or approval process for these categories.</p>
      <p>FDA registration applies to <strong>manufacturing facilities</strong>. The regulatory focus is on the production site, not on individual product SKUs or brand names.</p>
      <p>Product compliance is determined by <strong>ingredient legality, proper labeling structure, and valid facility registration status</strong>. These are the structural elements that define market entry readiness.</p>
    </div>
  </div>
</section>

<footer>
  <div class="footer-l"><span data-en="¬© 2026 GoToMarket Compliance Lab. For informational purposes only." data-cn="¬© 2026 GoToMarket Compliance Lab. ‰ªÖ‰æõ‰ø°ÊÅØÂèÇËÄÉ„ÄÇ">¬© 2026 GoToMarket Compliance Lab. For informational purposes only.</span></div>
  <div class="footer-r"><a href="#" data-en="Privacy" data-cn="ÈöêÁßÅÊîøÁ≠ñ">Privacy</a><a href="#" data-en="Terms" data-cn="ÊúçÂä°Êù°Ê¨æ">Terms</a><a href="#" data-en="Contact" data-cn="ËÅîÁ≥ªÊàë‰ª¨">Contact</a></div>
</footer>
<div style="text-align:center;padding:0 var(--pad) 24px;font-size:10px;color:var(--text-3);opacity:0.7;line-height:1.6;font-family:var(--font-cn)"><span data-en="This report is generated based on user-provided information and AI-assisted structural analysis. It does not constitute legal advice or official FDA verification. Professional consultation is recommended before execution." data-cn="Êú¨Êä•ÂëäÂü∫‰∫éÁî®Êà∑Êèê‰æõ‰ø°ÊÅØÂèäAIËæÖÂä©ÁªìÊûÑÂàÜÊûêÁîüÊàêÔºå‰∏çÊûÑÊàêÊ≥ïÂæãÊÑèËßÅÊàñFDAÂÆòÊñπÈ™åËØÅÁªìÊûú„ÄÇÂÆûÈôÖÊâßË°åÂâçÂª∫ËÆÆÂí®ËØ¢‰∏ì‰∏öÈ°æÈóÆ„ÄÇ">Êú¨Êä•ÂëäÂü∫‰∫éÁî®Êà∑Êèê‰æõ‰ø°ÊÅØÂèäAIËæÖÂä©ÁªìÊûÑÂàÜÊûêÁîüÊàêÔºå‰∏çÊûÑÊàêÊ≥ïÂæãÊÑèËßÅÊàñFDAÂÆòÊñπÈ™åËØÅÁªìÊûú„ÄÇÂÆûÈôÖÊâßË°åÂâçÂª∫ËÆÆÂí®ËØ¢‰∏ì‰∏öÈ°æÈóÆ„ÄÇ</span></div>

<!-- Auth Modal -->
<div class="modal-overlay" id="authModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeAuthModal()">‚úï</button>
    <div class="modal-title" id="authModalTitle">Welcome</div>
    <div class="modal-sub" id="authModalSub">Sign in to save and access your compliance reports</div>
    <div class="modal-tabs">
      <div class="modal-tab active" id="tabLogin" onclick="switchAuthTab('login')" data-en="Log In" data-cn="ÁôªÂΩï">Log In</div>
      <div class="modal-tab" id="tabRegister" onclick="switchAuthTab('register')" data-en="Sign Up" data-cn="Ê≥®ÂÜå">Sign Up</div>
    </div>
    <form class="modal-form active" id="formLogin" onsubmit="doLogin(event)">
      <div class="form-group"><label>Email</label><input class="form-input" type="email" id="loginEmail" required placeholder="your@email.com"></div>
      <div class="form-group"><label data-en="Password" data-cn="ÂØÜÁ†Å">Password</label><input class="form-input" type="password" id="loginPass" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div class="form-error" id="loginError"></div>
      <button class="form-btn form-btn-primary" type="submit" data-en="Log In" data-cn="ÁôªÂΩï">Log In</button>
    </form>
    <form class="modal-form" id="formRegister" onsubmit="doRegister(event)">
      <div class="form-group"><label data-en="Full Name" data-cn="ÂßìÂêç">Full Name</label><input class="form-input" type="text" id="regName" required placeholder="Your name"></div>
      <div class="form-group"><label>Email</label><input class="form-input" type="email" id="regEmail" required placeholder="your@email.com"></div>
      <div class="form-group"><label data-en="Company (Optional)" data-cn="ÂÖ¨Âè∏ÔºàÈÄâÂ°´Ôºâ">Company (Optional)</label><input class="form-input" type="text" id="regCompany" placeholder="Company name"></div>
      <div class="form-group"><label data-en="Password (min 6 chars)" data-cn="ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ">Password (min 6 chars)</label><input class="form-input" type="password" id="regPass" required minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div class="form-error" id="regError"></div>
      <button class="form-btn form-btn-primary" type="submit" data-en="Create Account" data-cn="ÂàõÂª∫Ë¥¶Êà∑">Create Account</button>
    </form>
  </div>
</div>

<!-- Dashboard Overlay (My Reports) -->
<div class="dash-overlay" id="dashOverlay">
  <button class="report-close" onclick="closeDashboard()">‚úï</button>
  <div class="dash-inner">
    <div class="dash-header">
      <h2 data-en="üìã My Reports" data-cn="üìã ÊàëÁöÑÊä•Âëä">üìã My Reports</h2>
      <button class="btn btn-ghost btn-sm" onclick="closeDashboard()" data-en="Back" data-cn="ËøîÂõû">Back</button>
    </div>
    <div class="saved-reports" id="savedReportsList"></div>
  </div>
</div>

<!-- Report Full-Screen Overlay -->
<div class="report-overlay" id="reportOverlay">
  <button class="report-close" onclick="closeReport()">‚úï</button>
  <div class="report-inner" id="reportOverlayContent"></div>
</div>

<!-- Extraction Review Overlay (Layer 1 ‚Üí Layer 2) -->
<div class="extract-overlay" id="extractOverlay">
  <button class="report-close" onclick="closeExtractOverlay()">‚úï</button>
  <div class="extract-inner" id="extractContent"></div>
</div>

<script>
// ===== State =====
let lang='cn', uploadedFiles=[], lastReportData=null, extractedData=null;
let _ingredientCounter=0, _nutritionCounter=0, _claimCounter=0;

// ===== Lang =====
function setLang(l){
  lang=l;
  document.getElementById('lEn').classList.toggle('active',l==='en');
  document.getElementById('lCn').classList.toggle('active',l==='cn');
  document.body.classList.toggle('cn',l==='cn');
  document.querySelectorAll('[data-en]').forEach(el=>{
    const v=el.getAttribute(l==='en'?'data-en':'data-cn');
    if(el.tagName==='INPUT'||el.tagName==='TEXTAREA')el.placeholder=v;
    else el.innerHTML=v;
  });
}

function sTo(id){document.getElementById(id)?.scrollIntoView({behavior:'smooth',block:'start'})}

// ===== Upload =====
function handleDrop(e){e.preventDefault();e.target.closest('.upload-zone')?.classList.remove('dragover');if(e.dataTransfer.files.length)handleFiles(e.dataTransfer.files)}

function handleFiles(files){
  const ok=['image/jpeg','image/png','image/webp','application/pdf'];
  for(const f of files){if(ok.includes(f.type))uploadedFiles.push(f)}
  renderFiles();
}

function removeFile(i){uploadedFiles.splice(i,1);renderFiles()}

function renderFiles(){
  const list=document.getElementById('fileList');
  const bar=document.getElementById('analyzeBar');
  if(!uploadedFiles.length){list.innerHTML='';document.getElementById('upIcon').textContent='üì¶';bar.style.display='none';document.getElementById('stepIndicator').style.display='none';return}
  document.getElementById('upIcon').textContent='‚úÖ';
  bar.style.display='flex';
  updateSteps(1);
  list.innerHTML=uploadedFiles.map((f,i)=>{
    const ext=f.name.split('.').pop().toUpperCase();
    const icon=ext==='PDF'?'üìÑ':'üñºÔ∏è';
    const sz=f.size>1048576?(f.size/1048576).toFixed(1)+' MB':(f.size/1024).toFixed(0)+' KB';
    return `<div class="file-item" style="animation-delay:${i*0.04}s"><span>${icon}</span><span class="fn">${f.name}</span><span class="fs">${sz}</span><button class="fx" onclick="event.stopPropagation();removeFile(${i})">‚úï</button></div>`;
  }).join('');
}

// ===== Step Indicator =====
function updateSteps(active){
  const si=document.getElementById('stepIndicator');
  si.style.display='flex';
  ['step1','step2','step3'].forEach((id,i)=>{
    const el=document.getElementById(id);
    el.classList.remove('active','done');
    if(i+1<active)el.classList.add('done');
    else if(i+1===active)el.classList.add('active');
  });
}

// ===== Analysis (Layer 1: Extract) =====
async function startAnalysis(){
  if(!uploadedFiles.length)return;
  const btn=document.getElementById('analyzeBtn');
  const status=document.getElementById('analyzeStatus');
  btn.disabled=true;
  btn.style.opacity='.6';
  status.className='analyze-status';
  status.innerHTML=`<span class="spinner"></span>${lang==='cn'?'AI Ê≠£Âú®ËØÜÂà´‰∫ßÂìÅ‰ø°ÊÅØ...':'AI extracting product information...'}`;
  updateSteps(1);

  const formData=new FormData();
  formData.append('lang',lang);
  uploadedFiles.forEach(f=>formData.append('files',f));

  try{
    const res=await fetch('/api/extract',{method:'POST',body:formData});
    const json=await res.json();
    if(!res.ok){
      const detail=json.raw?`\n\nServer raw: ${json.raw.substring(0,200)}...`:'';
      throw new Error((json.error||'Extraction failed')+detail);
    }
    if(json.demo){
      status.innerHTML=lang==='cn'?'‚ö†Ô∏è ÊºîÁ§∫Ê®°Âºè ‚Äî ËØ∑ÈÖçÁΩÆ GEMINI_API_KEY Ëé∑ÂèñÁúüÂÆûËØÜÂà´':'‚ö†Ô∏è Demo mode ‚Äî configure GEMINI_API_KEY for real extraction';
    } else {
      status.innerHTML=lang==='cn'?'‚úÖ ËØÜÂà´ÂÆåÊàêÔºåËØ∑ÂÆ°Ê†∏':'‚úÖ Extraction complete ‚Äî please review';
    }
    extractedData=json.data;
    renderExtractionForm(extractedData);
    openExtractOverlay();
    updateSteps(2);
  }catch(err){
    status.className='analyze-status error';
    status.textContent=`‚ùå ${err.message}`;
  }finally{
    btn.disabled=false;
    btn.style.opacity='1';
  }
}

// ===== Extraction Overlay =====
function openExtractOverlay(){
  document.getElementById('extractOverlay').classList.add('active');
  document.body.style.overflow='hidden';
  // Reset confirm state (elements are rendered inside extractContent)
  const cb=document.getElementById('confirmCheck');
  const btn=document.getElementById('confirmAnalyzeBtn');
  if(cb)cb.checked=false;
  if(btn)btn.disabled=true;
}
function closeExtractOverlay(){
  document.getElementById('extractOverlay').classList.remove('active');
  document.body.style.overflow='';
}
function toggleConfirmBtn(){
  document.getElementById('confirmAnalyzeBtn').disabled=!document.getElementById('confirmCheck').checked;
}

// ===== Escape HTML =====
function escHtml(s){if(!s)return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// ===== Render Extraction Form =====
function renderExtractionForm(d){
  const cn=lang==='cn';
  _ingredientCounter=0;_nutritionCounter=0;_claimCounter=0;
  let h='';

  // Header
  h+=`<div class="report-header">
    <div class="report-brand">GoToMarket Compliance Lab</div>
    <div class="report-title">${cn?'‰∫ßÂìÅ‰ø°ÊÅØÁ°ÆËÆ§':'Product Information Review'}</div>
    <div class="report-meta">${cn?'ËØ∑Ê†∏ÂØπ AI ËØÜÂà´ÁöÑ‰∫ßÂìÅ‰ø°ÊÅØÔºåÂ¶ÇÊúâÈîôËØØËØ∑ÊâãÂä®‰øÆÊ≠£„ÄÇÁ°ÆËÆ§Êó†ËØØÂêéÁîüÊàêÂêàËßÑÊä•Âëä„ÄÇ':'Please review the AI-extracted product data. Correct any errors before generating the compliance report.'}</div>
  </div>`;

  // Product Name
  h+=`<div class="extract-section">
    <div class="extract-section-title">${cn?'‰∫ßÂìÅÂêçÁß∞':'Product Name'}</div>
    <div class="field-grid">
      <div class="field-group"><label>${cn?'Ëã±ÊñáÂêçÁß∞':'English Name'}</label><input class="ext-input" id="ext-productName" value="${escHtml(d.productName||'')}"></div>
      <div class="field-group"><label>${cn?'‰∏≠ÊñáÂêçÁß∞':'Chinese Name'}</label><input class="ext-input" id="ext-productNameCn" value="${escHtml(d.productNameCn||'')}"></div>
      <div class="field-group"><label>${cn?'‰∫ßÂìÅÁ±ªÂûã':'Product Type'}</label><input class="ext-input" id="ext-productType" value="${escHtml(d.productType||'')}" placeholder="${cn?'È£üÂìÅ / ËÜ≥È£üË°•ÂÖÖÂâÇ / È•ÆÊñô':'food / dietary supplement / beverage'}"></div>
    </div>
  </div>`;

  // Ingredients
  h+=`<div class="extract-section">
    <div class="extract-section-title">${cn?'ÊàêÂàÜÂàóË°®':'Ingredient List'}
      <button class="btn btn-ghost btn-sm" onclick="addIngredient()" style="font-size:11px">+ ${cn?'Ê∑ªÂä†ÊàêÂàÜ':'Add Ingredient'}</button>
    </div>
    <div id="ingredientList">`;
  (d.ingredients||[]).forEach(ing=>{h+=renderIngredientRow(ing)});
  h+=`</div></div>`;

  // Nutrition Facts
  h+=`<div class="extract-section">
    <div class="extract-section-title">${cn?'Ëê•ÂÖªÊàêÂàÜ':'Nutrition Facts'}
      <button class="btn btn-ghost btn-sm" onclick="addNutrient()" style="font-size:11px">+ ${cn?'Ê∑ªÂä†':'Add'}</button>
    </div>
    <div id="nutritionList">`;
  (d.nutritionFacts||[]).forEach(nf=>{h+=renderNutritionRow(nf)});
  h+=`</div></div>`;

  // Allergens
  h+=`<div class="extract-section">
    <div class="extract-section-title">${cn?'ËøáÊïèÂéü':'Allergens'}</div>
    <div class="allergen-tags" id="allergenTags">`;
  (d.allergens||[]).forEach(a=>{
    h+=`<span class="allergen-tag">${escHtml(a)}<button onclick="this.parentElement.remove()">‚úï</button></span>`;
  });
  h+=`</div>
    <div class="allergen-add" style="margin-top:8px">
      <input class="ext-input-sm" id="newAllergen" placeholder="${cn?'ËæìÂÖ•ËøáÊïèÂéü':'Enter allergen'}" style="width:160px" onkeydown="if(event.key==='Enter'){event.preventDefault();addAllergen()}">
      <button class="btn btn-ghost btn-sm" onclick="addAllergen()" style="font-size:11px;padding:6px 12px">+</button>
    </div>
  </div>`;

  // Label Info
  h+=`<div class="extract-section">
    <div class="extract-section-title">${cn?'Ê†áÁ≠æ‰ø°ÊÅØ':'Label Information'}</div>
    <div class="field-grid">
      <div class="field-group"><label>${cn?'ÂáÄÂê´Èáè':'Net Weight'}</label><input class="ext-input" id="ext-netWeight" value="${escHtml(d.netWeight||'')}"></div>
      <div class="field-group"><label>${cn?'ÊØè‰ªΩÂ§ßÂ∞è':'Serving Size'}</label><input class="ext-input" id="ext-servingSize" value="${escHtml(d.servingSize||'')}"></div>
      <div class="field-group"><label>${cn?'ÊØèÂÆπÂô®‰ªΩÊï∞':'Servings/Container'}</label><input class="ext-input" id="ext-servingsPerContainer" value="${escHtml(d.servingsPerContainer||'')}"></div>
      <div class="field-group"><label>${cn?'Âéü‰∫ßÂõΩ':'Country of Origin'}</label><input class="ext-input" id="ext-countryOfOrigin" value="${escHtml(d.countryOfOrigin||'')}"></div>
      <div class="field-group" style="grid-column:1/-1"><label>${cn?'Âà∂ÈÄ†ÂïÜ‰ø°ÊÅØ':'Manufacturer Info'}</label><input class="ext-input" id="ext-manufacturerInfo" value="${escHtml(d.manufacturerInfo||'')}"></div>
    </div>
  </div>`;

  // Label Claims
  h+=`<div class="extract-section">
    <div class="extract-section-title">${cn?'ÂÆ£‰º†Â£∞Áß∞':'Label Claims'}
      <button class="btn btn-ghost btn-sm" onclick="addClaim()" style="font-size:11px">+ ${cn?'Ê∑ªÂä†Â£∞Áß∞':'Add Claim'}</button>
    </div>
    <div id="claimsList">`;
  (d.labelClaims||[]).forEach(c=>{h+=renderClaimRow(c)});
  h+=`</div></div>`;

  // FDA Facility Registration - status selectors (no sensitive company info)
  h+=`<div class="extract-section highlight">
    <div class="extract-section-title">${cn?'FDA ËÆæÊñΩÊ≥®ÂÜåÁä∂ÊÄÅ':'FDA Facility Registration Status'}
      <span style="font-size:11px;color:var(--text-3);font-weight:400">${cn?'(ËØ∑ÈÄâÊã©ÂΩìÂâçÁä∂ÊÄÅ)':'(Select current status)'}</span>
    </div>

    <div class="fda-status-group">
      <label class="fda-status-label">${cn?'1. Áîü‰∫ßÂ∑•ÂéÇ FDA Ê≥®ÂÜåÁä∂ÊÄÅ':'1. Manufacturing Facility Registration'}</label>
      <div class="fda-radio-row">
        <label class="fda-radio"><input type="radio" name="facilityRegStatus" value="active"><span>${cn?'Â∑≤Á°ÆËÆ§ÊúâÊïà':'Confirmed active'}</span></label>
        <label class="fda-radio"><input type="radio" name="facilityRegStatus" value="expired"><span>${cn?'ÂèØËÉΩÂ∑≤ËøáÊúü':'Possibly expired'}</span></label>
        <label class="fda-radio"><input type="radio" name="facilityRegStatus" value="not_registered"><span>${cn?'Êú™Ê≥®ÂÜå':'Not registered'}</span></label>
        <label class="fda-radio"><input type="radio" name="facilityRegStatus" value="unknown" checked><span>${cn?'‰∏çÁ°ÆÂÆö':'Unknown'}</span></label>
      </div>
    </div>

    <div class="fda-status-group">
      <label class="fda-status-label">${cn?'2. ÁæéÂõΩ‰ª£ÁêÜ‰∫∫ÊåáÂÆöÊÉÖÂÜµ':'2. U.S. Agent Appointment'}</label>
      <div class="fda-radio-row">
        <label class="fda-radio"><input type="radio" name="usAgentStatus" value="appointed"><span>${cn?'Â∑≤ÊåáÂÆö':'Appointed'}</span></label>
        <label class="fda-radio"><input type="radio" name="usAgentStatus" value="not_appointed"><span>${cn?'Êú™ÊåáÂÆö':'Not appointed'}</span></label>
        <label class="fda-radio"><input type="radio" name="usAgentStatus" value="unknown" checked><span>${cn?'‰∏çÁ°ÆÂÆö':'Unknown'}</span></label>
      </div>
    </div>

    <div class="fda-status-group">
      <label class="fda-status-label">${cn?'3. FSVP ËøõÂè£Ë¥£‰ªªÊñπ':'3. FSVP Importer Identified'}</label>
      <div class="fda-radio-row">
        <label class="fda-radio"><input type="radio" name="fsvpStatus" value="yes"><span>${cn?'Â∑≤Á°ÆÂÆö':'Yes'}</span></label>
        <label class="fda-radio"><input type="radio" name="fsvpStatus" value="no"><span>${cn?'Êú™Á°ÆÂÆö':'No'}</span></label>
        <label class="fda-radio"><input type="radio" name="fsvpStatus" value="tbd" checked><span>${cn?'ÂæÖÁ°ÆËÆ§':'To be determined'}</span></label>
      </div>
    </div>

    <div class="fda-status-group">
      <label class="fda-status-label">${cn?'4. ËøõÂè£ÂïÜÁªìÊûÑ':'4. Importer of Record Structure'}</label>
      <div class="fda-radio-row">
        <label class="fda-radio"><input type="radio" name="importerStructure" value="us_distributor"><span>${cn?'ÁæéÂõΩÁªèÈîÄÂïÜ':'U.S. distributor'}</span></label>
        <label class="fda-radio"><input type="radio" name="importerStructure" value="self_import"><span>${cn?'Ëá™Ë°åËøõÂè£':'Self-import'}</span></label>
        <label class="fda-radio"><input type="radio" name="importerStructure" value="third_party"><span>${cn?'Á¨¨‰∏âÊñπËøõÂè£ÂïÜ':'Third-party importer'}</span></label>
        <label class="fda-radio"><input type="radio" name="importerStructure" value="not_determined" checked><span>${cn?'Êú™Á°ÆÂÆö':'Not determined'}</span></label>
      </div>
    </div>

    <div class="fda-optional-id">
      <label class="fda-status-label">${cn?'Â∑•ÂéÇËØÜÂà´ÁºñÂè∑ÔºàÂèØÈÄâÂ°´ÂÜôÔºå‰∏çËøõË°åÂÆòÊñπÈ™åËØÅÔºâ':'Facility Identification Number (Optional ‚Äì not verified)'}</label>
      <span style="font-size:11px;color:var(--text-3);display:block;margin:4px 0 8px">${cn?'Áî±Áî®Êà∑Ëá™Ë°åÂ°´ÂÜôÔºåÂπ≥Âè∞‰∏çËøõË°å FDA Êï∞ÊçÆÂ∫ìÊ†∏È™å„ÄÇ':'User-provided only. Not validated against FDA databases.'}</span>
      <input class="ext-input" id="ext-facilityIdNumber" value="" placeholder="${cn?'Â¶ÇÊúâËØ∑Â°´ÂÜôÔºàÂèØÈÄâÔºâ':'Enter if available (optional)'}">
    </div>
  </div>`;

  // Confirm bar (inline, at bottom of form)
  h+=`<div class="confirm-bar">
    <label class="confirm-check">
      <input type="checkbox" id="confirmCheck" onchange="toggleConfirmBtn()">
      <span>${cn?'ÊàëÁ°ÆËÆ§‰ª•‰∏ä‰ø°ÊÅØ‰∏∫ÊúÄÁªà‰∫ßÂìÅÊàêÂàÜ‰∏éÊ†áÁ≠æ‰ø°ÊÅØ':'I confirm this is the final product information'}</span>
    </label>
    <button class="btn btn-accent btn-lg" id="confirmAnalyzeBtn" disabled onclick="startLayer2Analysis()">
      ${cn?'üöÄ ÁîüÊàêÂêàËßÑÊä•Âëä':'üöÄ Generate Compliance Report'}
    </button>
  </div>`;

  document.getElementById('extractContent').innerHTML=h;
}

// ===== Dynamic Rows =====
function renderIngredientRow(ing){
  const i=_ingredientCounter++;
  return `<div class="ext-row" id="ing-${i}">
    <span class="ext-row-num">${i+1}</span>
    <input class="ext-input" placeholder="Name" value="${escHtml(ing.name||'')}" data-ing-name="${i}">
    <input class="ext-input-sm" placeholder="Amt" value="${escHtml(ing.amount||'')}" data-ing-amount="${i}" style="width:80px">
    <input class="ext-input-sm" placeholder="Unit" value="${escHtml(ing.unit||'')}" data-ing-unit="${i}" style="width:60px">
    <button class="ext-remove" onclick="document.getElementById('ing-${i}').remove()">‚úï</button>
  </div>`;
}
function addIngredient(){
  document.getElementById('ingredientList').insertAdjacentHTML('beforeend',renderIngredientRow({name:'',amount:'',unit:''}));
}

function renderNutritionRow(nf){
  const i=_nutritionCounter++;
  return `<div class="ext-row" id="nf-${i}">
    <input class="ext-input" placeholder="Nutrient" value="${escHtml(nf.nutrient||'')}" data-nf-nutrient="${i}">
    <input class="ext-input-sm" placeholder="Amount" value="${escHtml(nf.amount||'')}" data-nf-amount="${i}" style="width:100px">
    <input class="ext-input-sm" placeholder="% DV" value="${escHtml(nf.dailyValue||'')}" data-nf-dv="${i}" style="width:70px">
    <button class="ext-remove" onclick="document.getElementById('nf-${i}').remove()">‚úï</button>
  </div>`;
}
function addNutrient(){
  document.getElementById('nutritionList').insertAdjacentHTML('beforeend',renderNutritionRow({nutrient:'',amount:'',dailyValue:''}));
}

function renderClaimRow(c){
  const i=_claimCounter++;
  return `<div class="ext-row" id="cl-${i}">
    <input class="ext-input" placeholder="Claim (EN)" value="${escHtml(c.claim||'')}" data-cl-claim="${i}">
    <input class="ext-input" placeholder="‰∏≠Êñá" value="${escHtml(c.claimCn||'')}" data-cl-cn="${i}">
    <button class="ext-remove" onclick="document.getElementById('cl-${i}').remove()">‚úï</button>
  </div>`;
}
function addClaim(){
  document.getElementById('claimsList').insertAdjacentHTML('beforeend',renderClaimRow({claim:'',claimCn:''}));
}

function addAllergen(){
  const inp=document.getElementById('newAllergen');
  const v=inp.value.trim();
  if(!v)return;
  document.getElementById('allergenTags').insertAdjacentHTML('beforeend',
    `<span class="allergen-tag">${escHtml(v)}<button onclick="this.parentElement.remove()">‚úï</button></span>`);
  inp.value='';
}

// ===== Collect Confirmed Data =====
function collectConfirmedData(){
  const data={
    productName:(document.getElementById('ext-productName')?.value||'').trim(),
    productNameCn:(document.getElementById('ext-productNameCn')?.value||'').trim(),
    productType:(document.getElementById('ext-productType')?.value||'').trim(),
    ingredients:[],
    nutritionFacts:[],
    allergens:[],
    netWeight:(document.getElementById('ext-netWeight')?.value||'').trim(),
    servingSize:(document.getElementById('ext-servingSize')?.value||'').trim(),
    servingsPerContainer:(document.getElementById('ext-servingsPerContainer')?.value||'').trim(),
    countryOfOrigin:(document.getElementById('ext-countryOfOrigin')?.value||'').trim(),
    manufacturerInfo:(document.getElementById('ext-manufacturerInfo')?.value||'').trim(),
    labelClaims:[],
    fdaStatus:{
      facilityRegStatus:document.querySelector('input[name="facilityRegStatus"]:checked')?.value||'unknown',
      usAgentStatus:document.querySelector('input[name="usAgentStatus"]:checked')?.value||'unknown',
      fsvpStatus:document.querySelector('input[name="fsvpStatus"]:checked')?.value||'tbd',
      importerStructure:document.querySelector('input[name="importerStructure"]:checked')?.value||'not_determined',
      facilityIdNumber:(document.getElementById('ext-facilityIdNumber')?.value||'').trim(),
    }
  };
  // Ingredients
  document.querySelectorAll('#ingredientList .ext-row').forEach(row=>{
    const name=row.querySelector('[data-ing-name]')?.value?.trim();
    if(name){
      data.ingredients.push({
        name,
        amount:row.querySelector('[data-ing-amount]')?.value?.trim()||'',
        unit:row.querySelector('[data-ing-unit]')?.value?.trim()||''
      });
    }
  });
  // Nutrition
  document.querySelectorAll('#nutritionList .ext-row').forEach(row=>{
    const nutrient=row.querySelector('[data-nf-nutrient]')?.value?.trim();
    if(nutrient){
      data.nutritionFacts.push({
        nutrient,
        amount:row.querySelector('[data-nf-amount]')?.value?.trim()||'',
        dailyValue:row.querySelector('[data-nf-dv]')?.value?.trim()||''
      });
    }
  });
  // Allergens
  document.querySelectorAll('#allergenTags .allergen-tag').forEach(tag=>{
    const txt=tag.childNodes[0]?.textContent?.trim();
    if(txt)data.allergens.push(txt);
  });
  // Claims
  document.querySelectorAll('#claimsList .ext-row').forEach(row=>{
    const claim=row.querySelector('[data-cl-claim]')?.value?.trim();
    if(claim){
      data.labelClaims.push({
        claim,
        claimCn:row.querySelector('[data-cl-cn]')?.value?.trim()||''
      });
    }
  });
  return data;
}

// ===== Layer 2: Confirmed Analysis =====
async function startLayer2Analysis(){
  const confirmed=collectConfirmedData();
  const btn=document.getElementById('confirmAnalyzeBtn');
  const origHtml=btn.innerHTML;
  btn.disabled=true;
  btn.innerHTML=`<span class="spinner"></span>${lang==='cn'?'AI ÂêàËßÑÂàÜÊûê‰∏≠...':'Analyzing compliance...'}`;

  try{
    const res=await fetch('/api/analyze-confirmed',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({confirmedData:confirmed,lang})
    });
    const json=await res.json();
    if(!res.ok){
      const detail=json.raw?`\n\nServer raw: ${json.raw.substring(0,200)}...`:'';
      throw new Error((json.error||'Analysis failed')+detail);
    }
    closeExtractOverlay();
    updateSteps(3);
    const statusEl=document.getElementById('analyzeStatus');
    if(json.demo){
      statusEl.innerHTML=lang==='cn'?'‚ö†Ô∏è ÊºîÁ§∫Ê®°Âºè ‚Äî ËØ∑ÈÖçÁΩÆ GEMINI_API_KEY Ëé∑ÂèñÁúüÂÆûÂàÜÊûê':'‚ö†Ô∏è Demo mode ‚Äî configure GEMINI_API_KEY for real analysis';
    } else {
      statusEl.innerHTML=lang==='cn'?'‚úÖ ÂàÜÊûêÂÆåÊàê':'‚úÖ Analysis complete';
    }
    renderReport(json.data);
    setTimeout(()=>sTo('dashboard'),300);
  }catch(err){
    alert((lang==='cn'?'ÂàÜÊûêÂ§±Ë¥•Ôºö':'Analysis failed: ')+err.message);
    btn.disabled=false;
    btn.innerHTML=origHtml;
  }
}

// ===== Render Report (Full-Screen Overlay) =====
function renderReport(d){
  lastReportData=d;
  // Preload CJK fonts in background for faster PDF export
  if(!_fontCache.regular&&!_fontCache.loading) _loadCJKFonts().catch(function(){});
  const cn=lang==='cn';
  const now=new Date();
  const dateStr=now.toLocaleDateString(cn?'zh-CN':'en-US',{year:'numeric',month:'long',day:'numeric'});
  const reportId='GTM-'+Date.now().toString(36).toUpperCase();

  function tagClass(s){return s==='pass'?'tag-pass':s==='warn'?'tag-warn':s==='fail'?'tag-fail':'tag-info'}
  function riskGrad(p){return p>65?'linear-gradient(90deg,var(--warn),var(--danger))':p>35?'linear-gradient(90deg,var(--success),var(--warn))':'linear-gradient(90deg,var(--success),var(--accent))'}

  let html='';
  // Report Header
  html+=`<div class="report-header">
    <div class="report-brand">GoToMarket Compliance Lab</div>
    <div class="report-title">${cn?'‰∫ßÂìÅÂêàËßÑÁªìÊûÑËØÑ‰º∞Êä•Âëä':'Product Compliance Structural Assessment Report'}</div>
    <div class="report-meta">${cn?'Êä•ÂëäÊó•Êúü':'Report Date'}: ${dateStr}„ÄÄ|„ÄÄID: ${reportId}</div>
    <div class="report-note">${cn?'Êú¨Âπ≥Âè∞Êèê‰æõÂü∫‰∫éÂÖ¨ÂºÄÊ≥ïËßÑÊ°ÜÊû∂ÁöÑÁªìÊûÑÊÄßÂêàËßÑËØÑ‰º∞‰∏éÈ£éÈô©ÊèêÁ§∫ÊúçÂä°„ÄÇÊä•ÂëäÂÜÖÂÆπ‰∏çÊûÑÊàêÊ≥ïÂæãÊÑèËßÅ„ÄÅÁõëÁÆ°ÊâπÂáÜÊàñÂÆòÊñπËÆ§ËØÅ„ÄÇÊúÄÁªàÂêàËßÑÂà§Êñ≠Â∫îÁî±ÊåÅÁâåÊ≥ïÂæã‰∏ì‰∏ö‰∫∫Â£´Á°ÆËÆ§„ÄÇ':'This platform provides structural compliance assessments and risk identification based on publicly available regulatory frameworks. The report does not constitute legal advice, regulatory approval, or official certification. Final compliance determinations should be confirmed by licensed legal professionals.'}</div>
  </div>`;

  html+='<div class="dash-grid">';

  // Ingredient Risk - with regulatory citations
  const ir=d.ingredientRisk;
  html+=`<div class="dash-card"><div class="dash-hd"><span class="dash-t">üß™ ${cn?'ÊàêÂàÜÂêàËßÑÁªìÊûÑÂàÜÊûê':'Ingredient Compliance Analysis'}</span><span class="tag ${tagClass(ir.status)}">${ir.flagCount} ${cn?'È°πÊ†áËÆ∞':'Items'}</span></div><div class="dash-body">`;
  ir.items.forEach(it=>{
    const name=cn?(it.nameCn||it.name):it.name;
    const note=it.note||it.status;
    html+=`<div class="dash-row"><span class="dash-row-l">${name}<span class="reg-ref">${it.regulation||''}</span></span><span class="tag ${tagClass(it.status)}">${note}</span></div>`;
  });
  html+=`<div class="risk-wrap"><div class="risk-label"><span>${cn?'È£éÈô©Á≠âÁ∫ß':'Risk Level'}</span><span>${cn?(ir.overallRisk==='high'?'È´òÈ£éÈô©':ir.overallRisk==='medium'?'‰∏≠Á≠âÈ£éÈô©':'‰ΩéÈ£éÈô©'):ir.overallRisk}</span></div><div class="risk-bar"><div class="risk-fill" style="width:${ir.riskPercent}%;background:${riskGrad(ir.riskPercent)}"></div></div></div>`;
  if(ir.summary)html+=`</div><div class="dash-summary">${ir.summary}</div>`;
  html+=`</div>`;

  // Label Compliance
  const lc=d.labelCompliance;
  html+=`<div class="dash-card"><div class="dash-hd"><span class="dash-t">üè∑Ô∏è ${cn?'Ê†áÁ≠æÂêàËßÑÊû∂ÊûÑÂÆ°Êü•':'Label Architecture Review'}</span><span class="tag ${tagClass(lc.status)}">${lc.passCount}/${lc.totalCount}</span></div><div class="dash-body">`;
  lc.items.forEach(it=>{
    const name=cn?(it.nameCn||it.name):it.name;
    html+=`<div class="dash-row"><span class="dash-row-l">${name}<span class="reg-ref">${it.regulation||''}</span></span><span class="tag ${tagClass(it.status)}">${it.note||it.status}</span></div>`;
  });
  if(lc.summary)html+=`</div><div class="dash-summary">${lc.summary}</div>`;
  html+=`</div>`;

  // Facility Registration - with FEI/DUNS note
  const fr=d.facilityRegistration;
  html+=`<div class="dash-card"><div class="dash-hd"><span class="dash-t">üè≠ ${cn?'Áîü‰∫ßËÆæÊñΩÊ≥®ÂÜåÊ†∏Êü•':'Facility Registration Verification'}</span><span class="tag ${tagClass(fr.status)}">${cn?'ÂæÖÊ†∏È™å':'Pending Verification'}</span></div><div class="dash-body">`;
  fr.items.forEach(it=>{
    const name=cn?(it.nameCn||it.name):it.name;
    html+=`<div class="dash-row"><span class="dash-row-l">${name}<span class="reg-ref">${it.regulation||''}</span></span><span class="tag ${tagClass(it.status)}">${it.value||it.status}</span></div>`;
  });
  html+=`<div class="facility-note">${cn?'Ê≥®ÔºöÈúÄ‰∏éÂ∑•ÂéÇÁ°ÆËÆ§ÊòØÂê¶ÊåÅÊúâËÆæÊñΩ FEI Êàñ DUNS ÁºñÂè∑ÔºåÂπ∂Á°Æ‰øùÂú®ÊúâÊïàÊúüÂÜÖ„ÄÇ':'Note: Facility FEI/DUNS information must be confirmed with the manufacturer and verified as currently active.'}</div>`;
  html+=`</div><div class="platform-note">${cn?'Êú¨Âπ≥Âè∞‰∏çÁõ¥Êé•ËÆøÈóÆ FDA ÂÜÖÈÉ®Êï∞ÊçÆÂ∫ìÔºå‰ªÖÂü∫‰∫éÂÖ¨ÂºÄ‰ø°ÊÅØ‰∏éÂÆ¢Êà∑Êèê‰æõËµÑÊñôËøõË°åÊ†∏Êü•„ÄÇ':'This platform does not directly access FDA internal databases. Verification is based on publicly available information and client-provided documentation.'}</div></div>`;

  // Marketing Claims
  const mc=d.marketingClaims;
  html+=`<div class="dash-card"><div class="dash-hd"><span class="dash-t">üí¨ ${cn?'ÂÆ£‰º†ËØ≠Ê≥ïËßÑÈ£éÈô©':'Marketing Claims Risk'}</span><span class="tag ${tagClass(mc.status)}">${mc.issueCount} ${cn?'È°πÂæÖÂÆ°':'Items'}</span></div><div class="dash-body">`;
  mc.items.forEach(it=>{
    const claim=cn?(it.claimCn||it.claim):it.claim;
    html+=`<div class="dash-row"><span class="dash-row-l">${claim}<span class="reg-ref">${it.regulation||''}</span></span><span class="tag ${tagClass(it.status)}">${it.note||it.status}</span></div>`;
  });
  html+=`<div class="risk-wrap"><div class="risk-label"><span>${cn?'ÂÆ£Áß∞È£éÈô©':'Claim Risk'}</span><span>${cn?(mc.riskLevel==='high'?'ËæÉÈ´ò':mc.riskLevel==='medium'?'‰∏≠Á≠â':'‰Ωé'):mc.riskLevel}</span></div><div class="risk-bar"><div class="risk-fill" style="width:${mc.riskPercent}%;background:${riskGrad(mc.riskPercent)}"></div></div></div>`;
  if(mc.summary)html+=`</div><div class="dash-summary">${mc.summary}</div>`;
  html+=`</div></div>`;

  // Risk Level Banner
  const rl=d.overallRiskLevel||'medium';
  const rlIcon=rl==='low'?'&#9679;':rl==='high'?'&#9650;':'&#9670;';
  const rlLabelEn=rl==='low'?'Low Risk':rl==='high'?'High Risk':'Medium Risk';
  const rlLabelCn=rl==='low'?'‰ΩéÁªìÊûÑÈ£éÈô©':rl==='high'?'È´òÁªìÊûÑÈ£éÈô©':'‰∏≠Á≠âÁªìÊûÑÈ£éÈô©';
  const recs=cn?(d.recommendationsCn||d.recommendations):d.recommendations;
  html+=`<div class="score-banner"><div class="risk-level-badge risk-${rl}"><div class="risk-level-icon">${rlIcon}</div><div class="risk-level-text">${cn?rlLabelCn:rlLabelEn}</div></div><div class="score-text"><div class="score-verdict">${cn?'ÁªìÊûÑÈ£éÈô©ËØÑ‰º∞':'Structural Risk Assessment'}</div><div class="score-sub">${cn?(d.overallVerdictCn||d.overallVerdict):d.overallVerdict}</div>`;
  if(recs&&recs.length){
    html+=`<div class="rec-list">`;
    recs.forEach(r=>{html+=`<div class="rec-item">${r}</div>`});
    html+=`</div>`;
  }
  html+=`</div></div>`;

  // Actions
  html+=`<div class="dash-actions">
    <button class="btn btn-accent btn-sm" onclick="requestConsult()" style="background:linear-gradient(135deg,var(--accent),var(--accent-dim))">üí¨ ${cn?'Áî≥ËØ∑‰∫∫Â∑•Âí®ËØ¢':'Request Expert Consultation'}</button>
    <button class="btn btn-ghost btn-sm" onclick="exportPDF()">‚¨á ${cn?'ÂØºÂá∫ PDF Êä•Âëä':'Export PDF Report'}</button>
    <button class="btn btn-ghost btn-sm" onclick="saveReport()" id="saveReportBtn" style="border-color:var(--gold);color:var(--gold)">üíæ ${cn?'‰øùÂ≠òÊä•Âëä':'Save Report'}</button>
  </div>`;

  // Legal footer
  html+=`<div style="text-align:center;padding:24px 0 0;font-size:10px;color:var(--text-3);opacity:0.6;line-height:1.6">${cn?'Êú¨Âπ≥Âè∞Êèê‰æõÂü∫‰∫éÂÖ¨ÂºÄÊ≥ïËßÑÊ°ÜÊû∂ÁöÑÁªìÊûÑÊÄßÂêàËßÑËØÑ‰º∞‰∏éÈ£éÈô©ÊèêÁ§∫ÊúçÂä°„ÄÇÊä•ÂëäÂÜÖÂÆπ‰∏çÊûÑÊàêÊ≥ïÂæãÊÑèËßÅ„ÄÅÁõëÁÆ°ÊâπÂáÜÊàñÂÆòÊñπËÆ§ËØÅ„ÄÇÊúÄÁªàÂêàËßÑÂà§Êñ≠Â∫îÁî±ÊåÅÁâåÊ≥ïÂæã‰∏ì‰∏ö‰∫∫Â£´Á°ÆËÆ§„ÄÇ':'This platform provides structural compliance assessments and risk identification based on publicly available regulatory frameworks. The report does not constitute legal advice, regulatory approval, or official certification. Final compliance determinations should be confirmed by licensed legal professionals.'}</div>`;

  // Open in overlay
  const overlay=document.getElementById('reportOverlay');
  document.getElementById('reportOverlayContent').innerHTML=html;
  overlay.classList.add('active');
  document.body.style.overflow='hidden';
}

function closeReport(){
  document.getElementById('reportOverlay').classList.remove('active');
  document.body.style.overflow='';
}

function requestConsult(){
  const cn=lang==='cn';
  alert(cn?'ÊÑüË∞¢ÊÇ®ÁöÑÂí®ËØ¢ËØ∑Ê±ÇÔºÅÊàë‰ª¨ÁöÑÂêàËßÑÈ°æÈóÆÂ∞ÜÂú® 24 Â∞èÊó∂ÂÜÖ‰∏éÊÇ®ËÅîÁ≥ª„ÄÇ\n\nÂ¶ÇÈúÄÂç≥Êó∂Âí®ËØ¢ÔºåËØ∑ÂèëÈÄÅÈÇÆ‰ª∂Ëá≥Ôºöcompliance@gotomarket-lab.com':'Thank you for your consultation request! Our compliance advisor will contact you within 24 hours.\n\nFor immediate inquiries, please email: compliance@gotomarket-lab.com');
}

// ===== CJK Font Loading for PDF =====
var _fontCache={regular:null,bold:null,loading:false};

function _arrayBufferToBase64(buf){
  var bytes=new Uint8Array(buf);
  var chunks=[];
  for(var i=0;i<bytes.length;i+=8192){
    chunks.push(String.fromCharCode.apply(null,bytes.subarray(i,Math.min(i+8192,bytes.length))));
  }
  return btoa(chunks.join(''));
}

async function _loadCJKFonts(){
  if(_fontCache.regular&&_fontCache.bold) return _fontCache;
  if(_fontCache.loading){
    while(_fontCache.loading) await new Promise(function(r){setTimeout(r,100)});
    return _fontCache;
  }
  _fontCache.loading=true;
  try{
    var res=await Promise.all([fetch('/fonts/NotoSansSC-Regular.ttf'),fetch('/fonts/NotoSansSC-Bold.ttf')]);
    if(!res[0].ok||!res[1].ok) throw new Error('Font files not found');
    var bufs=await Promise.all([res[0].arrayBuffer(),res[1].arrayBuffer()]);
    _fontCache.regular=_arrayBufferToBase64(bufs[0]);
    _fontCache.bold=_arrayBufferToBase64(bufs[1]);
    return _fontCache;
  }finally{_fontCache.loading=false;}
}

// ===== PDF Export (Professional with Cover, TOC, Disclaimer) =====
async function exportPDF(){
  var exportBtn=document.querySelector('[onclick="exportPDF()"]');
  var origText=exportBtn?exportBtn.textContent:'';
  try {
    // Check CDN loaded
    if(!window.jspdf){alert('PDF library not loaded. Please refresh the page and try again.');return;}
    // Load CJK fonts
    if(exportBtn){exportBtn.disabled=true;exportBtn.textContent=lang==='cn'?'‚è≥ Ê≠£Âú®Âä†ËΩΩÂ≠ó‰Ωì...':'‚è≥ Loading fonts...';}
    var fonts=await _loadCJKFonts();
    if(exportBtn){exportBtn.textContent=lang==='cn'?'‚è≥ Ê≠£Âú®ÁîüÊàê PDF...':'‚è≥ Generating PDF...';}
    const d = lastReportData || getDemoReportData();
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    // Register CJK fonts
    doc.addFileToVFS('NotoSansSC-Regular.ttf',fonts.regular);
    doc.addFont('NotoSansSC-Regular.ttf','NotoSansSC','normal');
    doc.addFileToVFS('NotoSansSC-Bold.ttf',fonts.bold);
    doc.addFont('NotoSansSC-Bold.ttf','NotoSansSC','bold');
    const W=210, H=297, M=18, CW=W-M*2;
    const cn=lang==='cn';
    const now=new Date();
    const dateStr=now.toLocaleDateString(cn?'zh-CN':'en-US',{year:'numeric',month:'long',day:'numeric'});
    const reportId='GTM-'+Date.now().toString(36).toUpperCase();

    const C={
      accent:[13,147,115], accentLight:[240,250,246],
      dark:[26,26,46], mid:[100,100,120], light:[150,150,170],
      white:[255,255,255], bg:[245,247,250],
      pass:[22,163,74], passBg:[220,252,231],
      warn:[217,119,6], warnBg:[254,243,199],
      fail:[220,38,38], failBg:[254,226,226],
      info:[37,99,235], infoBg:[219,234,254],
      border:[229,231,235], recBg:[255,251,235], recBorder:[253,230,138]
    };
    function statusColor(s){return s==='pass'?C.pass:s==='warn'?C.warn:s==='fail'?C.fail:C.info}
    let y=M;
    function checkPage(need){if(y+need>H-20){doc.addPage();y=M;return true}return false}
    function pageFooter(){
      const pn=doc.internal.getNumberOfPages();
      doc.setFontSize(7);doc.setTextColor(...C.light);
      doc.text(cn?'GoToMarket Compliance Lab  |  Êú∫ÂØÜÊñá‰ª∂':'GoToMarket Compliance Lab  |  Confidential',M,H-10);
      doc.text((cn?'Á¨¨ ':'Page ')+pn+(cn?' È°µ':''),W-M,H-10,{align:'right'});
    }

    // ======== PAGE 1: COVER ========
    doc.setFillColor(...C.accent);
    doc.rect(0,0,W,H,'F');
    doc.setFillColor(...C.white);
    doc.roundedRect(M,M,CW,H-M*2,4,4,'F');
    doc.setFont('NotoSansSC','bold');doc.setFontSize(14);doc.setTextColor(...C.accent);
    doc.text('GoToMarket Compliance Lab',M+16,M+24);
    doc.setFont('NotoSansSC','normal');doc.setFontSize(9);doc.setTextColor(...C.mid);
    doc.text(cn?'ÁæéÂõΩÈ£üÂìÅ‰∏éËÜ≥È£üË°•ÂÖÖÂâÇÊ≥ïËßÑÂêàËßÑÂàÜÊûêÂπ≥Âè∞':'Global Regulatory & Market Entry Intelligence Platform',M+16,M+31);
    doc.setDrawColor(...C.accent);doc.setLineWidth(1);
    doc.line(M+16,M+38,M+CW-16,M+38);
    doc.setFont('NotoSansSC','bold');doc.setFontSize(26);doc.setTextColor(...C.dark);
    doc.text(cn?'‰∫ßÂìÅÂêàËßÑ‰∏éÂ∏ÇÂú∫ÂáÜÂÖ•':'Product Compliance',M+16,M+62);
    doc.text(cn?'ËØÑ‰º∞Êä•Âëä':'Assessment Report',M+16,M+72);
    // Risk level box - calculate dynamic height
    var rlPdf=d.overallRiskLevel||'medium';
    var rlColorPdf=rlPdf==='low'?C.pass:rlPdf==='high'?C.fail:C.warn;
    var rlTextPdf=cn?(rlPdf==='low'?'‰ΩéÁªìÊûÑÈ£éÈô©':rlPdf==='high'?'È´òÁªìÊûÑÈ£éÈô©':'‰∏≠Á≠âÁªìÊûÑÈ£éÈô©'):(rlPdf==='low'?'LOW STRUCTURAL RISK':rlPdf==='high'?'HIGH STRUCTURAL RISK':'MEDIUM STRUCTURAL RISK');
    var vd=cn?(d.overallVerdictCn||d.overallVerdict||''):(d.overallVerdict||'');
    doc.setFont('NotoSansSC','normal');doc.setFontSize(8);
    var vdLines=doc.splitTextToSize(vd,CW-40);
    var vdH=vdLines.length*4;
    var riskBoxH=Math.max(36, 24+vdH);
    doc.setFillColor(...C.accentLight);
    doc.roundedRect(M+16,M+86,CW-32,riskBoxH,3,3,'F');
    // Risk badge
    var badgeW=cn?42:36;
    doc.setFillColor(...rlColorPdf);
    doc.roundedRect(M+20,M+90,badgeW,14,3,3,'F');
    doc.setFont('NotoSansSC','bold');doc.setFontSize(8);doc.setTextColor(...C.white);
    doc.text(rlTextPdf,M+20+badgeW/2,M+99,{align:'center'});
    // Risk title - right of badge
    var titleX=M+20+badgeW+6;
    doc.setFont('NotoSansSC','bold');doc.setFontSize(12);doc.setTextColor(...C.dark);
    doc.text(cn?'ÁªìÊûÑÈ£éÈô©ËØÑ‰º∞':'Structural Risk Assessment',titleX,M+96);
    // Verdict text - full width below badge row
    doc.setFont('NotoSansSC','normal');doc.setFontSize(8);doc.setTextColor(...C.mid);
    doc.text(vdLines,M+20,M+108);
    // Date and ID below risk box
    var afterBox=M+86+riskBoxH+12;
    doc.setFont('NotoSansSC','normal');doc.setFontSize(9);doc.setTextColor(...C.mid);
    doc.text((cn?'Êä•ÂëäÊó•ÊúüÔºö':'Report Date: ')+dateStr,M+16,afterBox);
    doc.text((cn?'Êä•ÂëäÁºñÂè∑Ôºö':'Report ID: ')+reportId,M+16,afterBox+7);
    // Disclaimer box
    doc.setFillColor(248,249,250);doc.setDrawColor(...C.border);doc.setLineWidth(0.3);
    doc.roundedRect(M+16,H-M-70,CW-32,30,2,2,'FD');
    doc.setFont('NotoSansSC','bold');doc.setFontSize(8);doc.setTextColor(...C.mid);
    doc.text(cn?'ÂÖçË¥£Â£∞Êòé':'DISCLAIMER',M+20,H-M-62);
    doc.setFont('NotoSansSC','normal');doc.setFontSize(7);doc.setTextColor(...C.light);
    var disc=cn?'Êú¨Êä•ÂëäÂü∫‰∫éÁî®Êà∑Êèê‰æõ‰ø°ÊÅØÂèäAIËæÖÂä©ÁªìÊûÑÂàÜÊûêÁîüÊàêÔºå‰∏çÊûÑÊàêÊ≥ïÂæãÊÑèËßÅÊàñFDAÂÆòÊñπÈ™åËØÅÁªìÊûú„ÄÇÂÆûÈôÖÊâßË°åÂâçÂª∫ËÆÆÂí®ËØ¢‰∏ì‰∏öÈ°æÈóÆ„ÄÇ':'This report is generated based on user-provided information and AI-assisted structural analysis. It does not constitute legal advice or official FDA verification. Professional consultation is recommended before execution.';
    doc.text(doc.splitTextToSize(disc,CW-40),M+20,H-M-56);
    doc.setFillColor(...C.accent);
    doc.rect(M,H-M-28,CW,28,'F');
    doc.setFont('NotoSansSC','bold');doc.setFontSize(10);doc.setTextColor(...C.white);
    doc.text('GoToMarket Compliance Lab',M+16,H-M-16);
    doc.setFont('NotoSansSC','normal');doc.setFontSize(7);doc.setTextColor(176,232,216);
    doc.text('(c) '+now.getFullYear()+' GoToMarket Compliance Lab. All rights reserved.',M+16,H-M-10);

    // ======== PAGE 2: TABLE OF CONTENTS ========
    doc.addPage();
    y=M;
    doc.setFillColor(...C.accent);doc.rect(0,0,W,3,'F');
    y=20;
    doc.setFont('NotoSansSC','bold');doc.setFontSize(18);doc.setTextColor(...C.dark);
    doc.text(cn?'ÁõÆÂΩï':'Table of Contents',M,y);
    y+=4;doc.setDrawColor(...C.accent);doc.setLineWidth(0.5);doc.line(M,y,M+50,y);
    y+=14;
    var toc=cn?[['1','ÊàêÂàÜÂêàËßÑÁªìÊûÑÂàÜÊûê'],['2','Ê†áÁ≠æÂêàËßÑÊû∂ÊûÑÂÆ°Êü•'],['3','Áîü‰∫ßËÆæÊñΩÊ≥®ÂÜåÊ†∏Êü•'],['4','ÂÆ£‰º†ËØ≠Ê≥ïËßÑÈ£éÈô©ËØÜÂà´'],['5','‰ºòÂåñÂª∫ËÆÆ'],['6','ÂÖçË¥£Â£∞Êòé‰∏éÊ≥ïÂæãÂëäÁü•']]:[['1','Ingredient Compliance Structural Analysis'],['2','Label Compliance Architecture Review'],['3','Facility Registration Verification'],['4','Marketing Claims Regulatory Risk Identification'],['5','Optimization Recommendations'],['6','Disclaimer & Legal Notice']];
    toc.forEach(function(item){
      doc.setFont('NotoSansSC','bold');doc.setFontSize(10);doc.setTextColor(...C.accent);
      doc.text(item[0]+'.',M,y);
      doc.setFont('NotoSansSC','normal');doc.setFontSize(10);doc.setTextColor(...C.dark);
      doc.text(item[1],M+10,y);
      y+=9;
    });
    pageFooter();

    // ======== SECTION PAGES ========
    function drawSection(title,sectionNum,items,nameKey,noteKey,summary,riskPercent,riskLabel,extraNote){
      doc.addPage();y=M;
      doc.setFillColor(...C.accent);doc.rect(0,0,W,3,'F');
      y=16;
      doc.setFont('NotoSansSC','bold');doc.setFontSize(8);doc.setTextColor(...C.accent);
      doc.text((cn?'Á¨¨ ':'SECTION ')+sectionNum+(cn?' ËäÇ':''),M,y);
      y+=7;
      doc.setFont('NotoSansSC','bold');doc.setFontSize(14);doc.setTextColor(...C.dark);
      doc.text(title,M,y);
      y+=4;doc.setDrawColor(...C.accent);doc.setLineWidth(0.5);doc.line(M,y,M+40,y);
      y+=8;

      var tableData=items.map(function(it){
        var en=it[nameKey]||'';
        var zhKey=nameKey+'Cn';
        var zh=it[zhKey]||'';
        var name=(en&&zh&&en!==zh)?(en+' / '+zh):(en||zh);
        var note=it[noteKey]||it.status||'';
        var reg=it.regulation||'';
        return [name,note,reg];
      });
      doc.autoTable({
        startY:y, margin:{left:M,right:M},
        head:[['Item / È°πÁõÆ','Assessment / ËØÑ‰º∞','Regulation / Ê≥ïËßÑÂºïÁî®']],
        body:tableData,
        theme:'striped',
        styles:{font:'NotoSansSC',fontStyle:'normal',fontSize:8,cellPadding:{top:3,bottom:3,left:3,right:3},textColor:C.dark,lineColor:C.border,lineWidth:0.15},
        headStyles:{font:'NotoSansSC',fillColor:C.bg,textColor:C.mid,fontStyle:'bold',fontSize:7},
        columnStyles:{0:{cellWidth:CW*0.36},1:{cellWidth:CW*0.38},2:{cellWidth:CW*0.26,fontStyle:'normal',textColor:C.light,fontSize:7}},
        didParseCell:function(data){
          if(data.section==='body'&&data.column.index===1){
            var st=items[data.row.index]?items[data.row.index].status:null;
            if(st)data.cell.styles.textColor=statusColor(st);
          }
        }
      });
      y=doc.lastAutoTable.finalY+6;

      if(typeof riskPercent==='number'){
        checkPage(12);
        doc.setFontSize(7);doc.setTextColor(...C.light);
        doc.text(riskLabel||(cn?'È£éÈô©Á≠âÁ∫ß':'Risk Level'),M,y+2);
        var rl=cn?(riskPercent>65?'È´ò':riskPercent>35?'‰∏≠Á≠â':'‰Ωé'):(riskPercent>65?'HIGH':riskPercent>35?'MEDIUM':'LOW');
        doc.text(rl,W-M,y+2,{align:'right'});
        y+=4;
        doc.setFillColor(...C.border);doc.roundedRect(M,y,CW,3,1,1,'F');
        var rc=riskPercent>65?C.fail:riskPercent>35?C.warn:C.pass;
        doc.setFillColor(...rc);doc.roundedRect(M,y,CW*riskPercent/100,3,1,1,'F');
        y+=8;
      }
      if(summary){
        checkPage(14);
        doc.setFillColor(250,250,250);doc.roundedRect(M,y,CW,12,2,2,'F');
        doc.setFont('NotoSansSC','normal');doc.setFontSize(8);doc.setTextColor(...C.light);
        doc.text(doc.splitTextToSize(summary,CW-8),M+4,y+5);
        y+=16;
      }
      if(extraNote){
        checkPage(14);
        doc.setFillColor(...C.infoBg);doc.roundedRect(M,y,CW,12,2,2,'F');
        doc.setFont('NotoSansSC','normal');doc.setFontSize(7);doc.setTextColor(...C.info);
        doc.text(doc.splitTextToSize(extraNote,CW-8),M+4,y+5);
        y+=16;
      }
      pageFooter();
    }

    var ir=d.ingredientRisk;
    drawSection(cn?'ÊàêÂàÜÂêàËßÑÁªìÊûÑÂàÜÊûê':'Ingredient Compliance Structural Analysis','1',ir.items,'name','note',ir.summary,ir.riskPercent,cn?'È£éÈô©Á≠âÁ∫ß':'Risk Level',null);

    var lc=d.labelCompliance;
    drawSection(cn?'Ê†áÁ≠æÂêàËßÑÊû∂ÊûÑÂÆ°Êü•':'Label Compliance Architecture Review','2',lc.items,'name','note',lc.summary,null,null,null);

    var fr=d.facilityRegistration;
    drawSection(cn?'Áîü‰∫ßËÆæÊñΩÊ≥®ÂÜåÊ†∏Êü•':'Facility Registration Verification','3',fr.items,'name','value',fr.summary,null,null,
      cn?'Ê≥®ÔºöËÆæÊñΩ FEI/DUNS ‰ø°ÊÅØÈúÄ‰∏éÂà∂ÈÄ†ÂïÜÁ°ÆËÆ§„ÄÇÊ†∏Êü•Âü∫‰∫éÂÖ¨ÂºÄ‰ø°ÊÅØÂèäÂÆ¢Êà∑Êèê‰æõÁöÑËµÑÊñô„ÄÇ':'Note: Facility FEI/DUNS information must be confirmed with the manufacturer. Verification is based on publicly available information and client-provided documentation.');

    var mc=d.marketingClaims;
    drawSection(cn?'ÂÆ£‰º†ËØ≠Ê≥ïËßÑÈ£éÈô©ËØÜÂà´':'Marketing Claims Regulatory Risk Identification','4',mc.items,'claim','note',mc.summary,mc.riskPercent,cn?'ÁªìÊûÑÈ£éÈô©':'Structural Risk',null);

    // ======== RECOMMENDATIONS PAGE ========
    var recs=cn?(d.recommendationsCn||d.recommendations||[]):(d.recommendations||[]);
    if(recs.length){
      doc.addPage();y=M;
      doc.setFillColor(...C.accent);doc.rect(0,0,W,3,'F');
      y=16;
      doc.setFont('NotoSansSC','bold');doc.setFontSize(8);doc.setTextColor(...C.accent);
      doc.text(cn?'Á¨¨ 5 ËäÇ':'SECTION 5',M,y);y+=7;
      doc.setFont('NotoSansSC','bold');doc.setFontSize(14);doc.setTextColor(...C.dark);
      doc.text(cn?'‰ºòÂåñÂª∫ËÆÆ':'Optimization Recommendations',M,y);
      y+=4;doc.setDrawColor(...C.accent);doc.setLineWidth(0.5);doc.line(M,y,M+40,y);y+=10;

      doc.setFillColor(...C.recBg);doc.setDrawColor(...C.recBorder);doc.setLineWidth(0.3);
      var recH=8+recs.length*8;
      doc.roundedRect(M,y,CW,recH,3,3,'FD');
      var ry=y+6;
      recs.forEach(function(rec,idx){
        doc.setFont('NotoSansSC','bold');doc.setFontSize(8);doc.setTextColor(146,64,14);
        doc.text((idx+1)+'.',M+4,ry);
        doc.setFont('NotoSansSC','normal');doc.setFontSize(8);doc.setTextColor(120,53,15);
        doc.text(doc.splitTextToSize(rec,CW-16),M+12,ry);
        ry+=8;
      });
      pageFooter();
    }

    // ======== DISCLAIMER PAGE ========
    doc.addPage();y=M;
    doc.setFillColor(...C.accent);doc.rect(0,0,W,3,'F');
    y=16;
    doc.setFont('NotoSansSC','bold');doc.setFontSize(8);doc.setTextColor(...C.accent);
    doc.text(cn?'Á¨¨ 6 ËäÇ':'SECTION 6',M,y);y+=7;
    doc.setFont('NotoSansSC','bold');doc.setFontSize(14);doc.setTextColor(...C.dark);
    doc.text(cn?'ÂÖçË¥£Â£∞Êòé‰∏éÊ≥ïÂæãÂëäÁü•':'Disclaimer & Legal Notice',M,y);
    y+=4;doc.setDrawColor(...C.accent);doc.setLineWidth(0.5);doc.line(M,y,M+40,y);y+=10;

    var disclaimers=cn?[
      'Êú¨Êä•ÂëäÂü∫‰∫éÁî®Êà∑Êèê‰æõ‰ø°ÊÅØÂèäAIËæÖÂä©ÁªìÊûÑÂàÜÊûêÁîüÊàêÔºå‰∏çÊûÑÊàêÊ≥ïÂæãÊÑèËßÅÊàñFDAÂÆòÊñπÈ™åËØÅÁªìÊûú„ÄÇ',
      'ÊâÄÊúâËÆæÊñΩÊ≥®ÂÜå‰ø°ÊÅØÂùá‰∏∫Áî®Êà∑Ëá™Êä•Áä∂ÊÄÅÔºåÂπ≥Âè∞‰∏çËøõË°åFDAÊï∞ÊçÆÂ∫ìÊ†∏È™å„ÄÇ',
      'ÂØπ‰∫éÈ£üÂìÅÂèäËÜ≥È£üË°•ÂÖÖÂâÇ‰∫ßÂìÅÔºåFDA‰∏çÂØπÂçï‰∏™‰∫ßÂìÅËøõË°åÂÆ°Êâπ„ÄÇÊ≥®ÂÜåÂØπË±°‰∏∫Áîü‰∫ßËÆæÊñΩÔºåËÄåÈùûÂçï‰∏™‰∫ßÂìÅÊàñÂìÅÁâå„ÄÇ',
      '‰∫ßÂìÅÂêàËßÑÂèñÂÜ≥‰∫éÊàêÂàÜÂêàÊ≥ïÊÄß„ÄÅÊ†áÁ≠æÁªìÊûÑËßÑËåÉ‰ª•ÂèäËÆæÊñΩÊ≥®ÂÜåÊúâÊïàÊÄß„ÄÇÂª∫ËÆÆËøõË°åÁã¨Á´ãÊ†∏È™å„ÄÇ',
      'ÂÆûÈôÖÊâßË°åÂâçÂª∫ËÆÆÂí®ËØ¢ÊåÅÁâåÊ≥ïÂæã‰∏ì‰∏ö‰∫∫Â£´„ÄÇ',
      'GoToMarket Compliance Lab ÂØπÂü∫‰∫éÊú¨Êä•ÂëäÂÜÖÂÆπÊâÄÈááÂèñÁöÑË°åÂä®‰∏çÊâøÊãÖ‰ªª‰ΩïË¥£‰ªª„ÄÇ'
    ]:[
      'This report is generated based on user-provided information and AI-assisted structural analysis. It does not constitute legal advice or official FDA verification.',
      'All facility registration data is user-reported status and is not validated against FDA databases.',
      'For food and dietary supplement products, FDA does not approve individual products. Registration applies to manufacturing facilities, not individual products or brands.',
      'Product compliance is determined by ingredient legality, proper labeling structure, and valid facility registration status. Independent verification recommended.',
      'Professional consultation is recommended before execution.',
      'GoToMarket Compliance Lab assumes no liability for actions taken based on the contents of this report.'
    ];
    disclaimers.forEach(function(txt,idx){
      doc.setFont('NotoSansSC','normal');doc.setFontSize(9);doc.setTextColor(...C.dark);
      var lines=doc.splitTextToSize((idx+1)+'. '+txt,CW-8);
      doc.text(lines,M+4,y);
      y+=lines.length*4.5+4;
    });

    y+=10;
    doc.setFillColor(...C.accent);doc.roundedRect(M,y,CW,20,3,3,'F');
    doc.setFont('NotoSansSC','bold');doc.setFontSize(10);doc.setTextColor(...C.white);
    doc.text('GoToMarket Compliance Lab',M+8,y+8);
    doc.setFont('NotoSansSC','normal');doc.setFontSize(7);doc.setTextColor(176,232,216);
    doc.text('(c) '+now.getFullYear()+' GoToMarket Compliance Lab. All rights reserved.',M+8,y+14);
    pageFooter();

    doc.save('GoToMarket_Compliance_Report_'+now.toISOString().split('T')[0]+'.pdf');
  } catch(err) {
    console.error('PDF export error:', err);
    var cn=lang==='cn';
    alert(cn?'PDF ÂØºÂá∫Â§±Ë¥•Ôºö'+err.message+'\n\nËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï„ÄÇ':'PDF export failed: '+err.message+'\n\nPlease try refreshing the page.');
  } finally {
    if(exportBtn){exportBtn.disabled=false;exportBtn.textContent=origText;}
  }
}

// Demo data fallback
function getDemoReportData(){
  return {
    ingredientRisk:{status:'warn',flagCount:3,items:[
      {name:'Sodium Benzoate (E211)',nameCn:'Sodium Benzoate / ËãØÁî≤ÈÖ∏Èí†',status:'pass',note:'FDA-affirmed GRAS status. Permitted as preservative under specified concentration limits.',regulation:'21 CFR 184.1733'},
      {name:'Red No. 40 (Allura Red)',nameCn:'Red No. 40 / ËØ±ÊÉëÁ∫¢40Âè∑',status:'warn',note:'Certified color additive. Requires batch certification and specific label declaration.',regulation:'21 CFR 74.340'},
      {name:'Steviol Glycosides',nameCn:'Steviol Glycosides / ÁîúËèäÁ≥ñËã∑',status:'pass',note:'GRAS self-affirmed per FDA no-objection letters. Verify purity specifications ‚â•95%.',regulation:'21 CFR 170.30 (GRAS); GRN No. 252'},
      {name:'Titanium Dioxide (E171)',nameCn:'Titanium Dioxide / ‰∫åÊ∞ßÂåñÈíõ',status:'fail',note:'Subject to ongoing FDA safety review. Confirm compliance with current guidance before use.',regulation:'21 CFR 73.575; FDA Safety Review 2024'}
    ],overallRisk:'medium',riskPercent:55,summary:'3 ingredient flags identified. Recommend verification of GRAS status and color additive certification prior to market entry.'},
    labelCompliance:{status:'warn',passCount:7,totalCount:9,items:[
      {name:'Nutrition Facts Panel',nameCn:'Nutrition Facts / Ëê•ÂÖªÊàêÂàÜË°®',status:'pass',note:'Compliant with updated format requirements.',regulation:'21 CFR 101.9 (2020 Final Rule)'},
      {name:'Allergen Declaration',nameCn:'Allergen Declaration / ËøáÊïèÂéüÂ£∞Êòé',status:'warn',note:'Major allergen (wheat) requires "Contains" statement or bold type declaration.',regulation:'FALCPA Sec. 203; 21 CFR 101.4'},
      {name:'Net Quantity (Dual Units)',nameCn:'Net Quantity / ÂáÄÂê´Èáè',status:'fail',note:'Missing U.S. customary units. Both metric and customary required.',regulation:'21 CFR 101.105'},
      {name:'Country of Origin',nameCn:'Country of Origin / Âéü‰∫ßÂõΩ',status:'pass',note:'Properly declared per marking requirements.',regulation:'19 CFR 134'},
      {name:'Product Identity Statement',nameCn:'Product Identity / ‰∫ßÂìÅÊ†áËØÜ',status:'pass',note:'Common name displayed on principal display panel.',regulation:'21 CFR 101.3'}
    ],summary:'7 of 9 label compliance checks passed. 2 items require correction before distribution.'},
    facilityRegistration:{status:'info',items:[
      {name:'FDA Facility Registration (FEI)',nameCn:'FDA Facility Registration / FDAËÆæÊñΩÊ≥®ÂÜå',value:'Pending ‚Äî confirm with manufacturer',status:'info',regulation:'21 CFR 1.225; FSMA Sec. 301'},
      {name:'DUNS Number',nameCn:'DUNS Number / DUNSÁºñÂè∑',value:'Pending ‚Äî confirm with manufacturer',status:'info',regulation:'FDA UFI Requirement'},
      {name:'FSVP Importer Compliance',nameCn:'FSVP Importer / FSVPËøõÂè£ÂïÜ',value:'Pending verification',status:'warn',regulation:'21 CFR Part 1 Subpart L'}
    ],summary:'Facility FEI and DUNS information must be confirmed with manufacturer and verified as currently active per 21 CFR 1.225.'},
    marketingClaims:{status:'warn',issueCount:2,items:[
      {claim:'"All Natural"',claimCn:'"All Natural" / "Á∫ØÂ§©ÁÑ∂"',status:'warn',note:'No FDA formal definition for "natural." Risk of enforcement action for misleading labeling.',regulation:'FD&C Act Sec. 403(a)(1); FDA Policy Notice 1991'},
      {claim:'"Boosts Immunity"',claimCn:'"Boosts Immunity" / "Â¢ûÂº∫ÂÖçÁñ´Âäõ"',status:'fail',note:'Constitutes unauthorized health claim. Requires FDA pre-market authorization or qualified health claim petition.',regulation:'DSHEA Sec. 403(r)(6); 21 CFR 101.93'},
      {claim:'"Low Sugar"',claimCn:'"Low Sugar" / "‰ΩéÁ≥ñ"',status:'pass',note:'Meets nutrient content claim criteria if product contains ‚â§5g sugar per RACC.',regulation:'21 CFR 101.60(c)'}
    ],riskLevel:'high',riskPercent:72,summary:'2 marketing claim issues identified. Unauthorized health claim presents significant regulatory risk.'},
    overallRiskLevel:'medium',
    overallVerdict:'Medium structural risk identified. Multiple items require optimization prior to U.S. market entry.',
    overallVerdictCn:'ËØÜÂà´Âà∞‰∏≠Á≠âÁªìÊûÑÈ£éÈô©„ÄÇÂ§öÈ°πÂÜÖÂÆπÈúÄÂú®ËøõÂÖ•ÁæéÂõΩÂ∏ÇÂú∫ÂâçËøõË°å‰ºòÂåñ„ÄÇ',
    recommendations:[
      'Add U.S. customary weight units (oz) per 21 CFR 101.105',
      'Add allergen "Contains" statement or bold declaration per FALCPA Sec. 203',
      'Review and revise health-related marketing claim "Boosts Immunity" per DSHEA Sec. 403(r)(6)',
      'Clarify or revise "All Natural" claim per FD&C Act Sec. 403(a)(1)',
      'Confirm facility FEI number and DUNS with manufacturer per 21 CFR 1.225'
    ],
    recommendationsCn:[
      '‰æùÊçÆ 21 CFR 101.105 Ê∑ªÂä†ÁæéÂà∂ÈáçÈáèÂçï‰Ωç (oz)',
      '‰æùÊçÆ FALCPA Sec. 203 Ê∑ªÂä†ËøáÊïèÂéü"Âê´Êúâ"Â£∞ÊòéÊàñÂä†Á≤óÊ†áÊ≥®',
      '‰æùÊçÆ DSHEA Sec. 403(r)(6) ÂÆ°Êü•Âπ∂‰øÆËÆ¢ÂÅ•Â∫∑Áõ∏ÂÖ≥ÂÆ£‰º†ËØ≠"Â¢ûÂº∫ÂÖçÁñ´Âäõ"',
      '‰æùÊçÆ FD&C Act Sec. 403(a)(1) ÊòéÁ°ÆÊàñ‰øÆËÆ¢"Á∫ØÂ§©ÁÑ∂"Â£∞Áß∞',
      '‰æùÊçÆ 21 CFR 1.225 ‰∏éÂ∑•ÂéÇÁ°ÆËÆ§ËÆæÊñΩ FEI ÁºñÂè∑Âèä DUNS ‰ø°ÊÅØ'
    ]
  };
}

// ===== PPT Export =====
async function exportPPTX(){
  const d = lastReportData || getDemoReportData();
  const cn = lang==='cn';

  // Show loading state on button
  const btns = document.querySelectorAll('[onclick="exportPPTX()"]');
  btns.forEach(b=>{b.disabled=true;b.style.opacity='.6';b.textContent=cn?'‚è≥ ÁîüÊàê‰∏≠...':'‚è≥ Generating...'});

  try {
    const res = await fetch('/api/generate-slides', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: d, lang })
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to generate slides');
    }

    // Download the blob
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `GoToMarket_Compliance_Report_${new Date().toISOString().split('T')[0]}.pptx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    alert(`PPT export failed: ${err.message}`);
  } finally {
    btns.forEach(b=>{b.disabled=false;b.style.opacity='1';b.textContent=cn?'üìä ÂØºÂá∫ PPT':'üìä Export PPT'});
  }
}

// ===== Auth State =====
let currentUser = null;

async function checkAuth() {
  try {
    const res = await fetch('/api/auth/me');
    const data = await res.json();
    currentUser = data.user;
    updateAuthUI();
  } catch(e) { currentUser = null; updateAuthUI(); }
}

function updateAuthUI() {
  const authBtns = document.getElementById('authBtns');
  const userMenu = document.getElementById('userMenu');
  if (currentUser) {
    authBtns.style.display = 'none';
    userMenu.style.display = 'flex';
    document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
    document.getElementById('userName').textContent = currentUser.name;
  } else {
    authBtns.style.display = 'flex';
    userMenu.style.display = 'none';
  }
}

function openAuthModal(tab) {
  document.getElementById('authModal').classList.add('active');
  switchAuthTab(tab || 'login');
}

function closeAuthModal() {
  document.getElementById('authModal').classList.remove('active');
  document.getElementById('loginError').classList.remove('show');
  document.getElementById('regError').classList.remove('show');
}

function switchAuthTab(tab) {
  document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
  document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
  document.getElementById('formLogin').classList.toggle('active', tab === 'login');
  document.getElementById('formRegister').classList.toggle('active', tab === 'register');
}

async function doLogin(e) {
  e.preventDefault();
  const errEl = document.getElementById('loginError');
  errEl.classList.remove('show');
  try {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: document.getElementById('loginEmail').value,
        password: document.getElementById('loginPass').value
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    currentUser = data.user;
    updateAuthUI();
    closeAuthModal();
  } catch(err) {
    errEl.textContent = err.message;
    errEl.classList.add('show');
  }
}

async function doRegister(e) {
  e.preventDefault();
  const errEl = document.getElementById('regError');
  errEl.classList.remove('show');
  try {
    const res = await fetch('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: document.getElementById('regName').value,
        email: document.getElementById('regEmail').value,
        company: document.getElementById('regCompany').value,
        password: document.getElementById('regPass').value
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    currentUser = data.user;
    updateAuthUI();
    closeAuthModal();
  } catch(err) {
    errEl.textContent = err.message;
    errEl.classList.add('show');
  }
}

async function doLogout() {
  await fetch('/api/auth/logout', { method: 'POST' });
  currentUser = null;
  updateAuthUI();
  closeUserDropdown();
}

function toggleUserDropdown() {
  document.getElementById('userDropdown').classList.toggle('open');
}
function closeUserDropdown() {
  document.getElementById('userDropdown').classList.remove('open');
}
document.addEventListener('click', function(e) {
  if (!e.target.closest('.user-menu') && !e.target.closest('.user-dropdown')) closeUserDropdown();
});

// ===== Dashboard (My Reports) =====
async function openDashboard() {
  closeUserDropdown();
  if (!currentUser) { openAuthModal('login'); return; }
  document.getElementById('dashOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
  loadSavedReports();
}

function closeDashboard() {
  document.getElementById('dashOverlay').classList.remove('active');
  document.body.style.overflow = '';
}

async function loadSavedReports() {
  const cn = lang === 'cn';
  const list = document.getElementById('savedReportsList');
  list.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-3)">Loading...</div>';
  try {
    const res = await fetch('/api/reports');
    const data = await res.json();
    if (!data.reports || !data.reports.length) {
      list.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><p>${cn ? 'ÊöÇÊó†Â∑≤‰øùÂ≠òÁöÑÊä•Âëä„ÄÇËøêË°åÂêàËßÑÂàÜÊûêÂêéÂç≥ÂèØ‰øùÂ≠ò„ÄÇ' : 'No saved reports yet. Run a compliance analysis and save it here.'}</p></div>`;
      return;
    }
    list.innerHTML = data.reports.map(r => {
      const date = new Date(r.created_at).toLocaleDateString(cn ? 'zh-CN' : 'en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      const rlClass = r.score <= 1 ? 'risk-low' : r.score <= 2 ? 'risk-medium' : 'risk-high';
      const rlText = cn ? (r.score <= 1 ? '‰ΩéÈ£éÈô©' : r.score <= 2 ? '‰∏≠È£éÈô©' : 'È´òÈ£éÈô©') : (r.score <= 1 ? 'Low' : r.score <= 2 ? 'Medium' : 'High');
      return `<div class="saved-card" onclick="loadReport('${r.report_id}')">
        <div class="saved-left"><div class="saved-title">${r.title}</div><div class="saved-meta">${r.report_id}  ¬∑  ${date}</div></div>
        <div class="saved-score ${rlClass}">${rlText}</div>
        <div class="saved-actions"><button class="saved-del" onclick="event.stopPropagation();deleteReport('${r.report_id}')" title="Delete">üóë</button></div>
      </div>`;
    }).join('');
  } catch(err) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>${err.message}</p></div>`;
  }
}

async function loadReport(reportId) {
  try {
    const res = await fetch('/api/reports/' + reportId);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    closeDashboard();
    renderReport(data.report.data);
  } catch(err) {
    alert('Failed to load report: ' + err.message);
  }
}

async function deleteReport(reportId) {
  const cn = lang === 'cn';
  if (!confirm(cn ? 'Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§Êä•ÂëäÂêóÔºü' : 'Delete this report?')) return;
  try {
    await fetch('/api/reports/' + reportId, { method: 'DELETE' });
    loadSavedReports();
  } catch(err) {
    alert('Failed to delete: ' + err.message);
  }
}

// ===== Save Report =====
async function saveReport() {
  const cn = lang === 'cn';
  if (!currentUser) { openAuthModal('login'); return; }
  if (!lastReportData) { alert(cn ? 'ËØ∑ÂÖàËøêË°åÂàÜÊûê' : 'Please run an analysis first'); return; }

  const btn = document.getElementById('saveReportBtn');
  if (btn) { btn.disabled = true; btn.textContent = cn ? '‚è≥ ‰øùÂ≠ò‰∏≠...' : '‚è≥ Saving...'; }
  try {
    const res = await fetch('/api/reports', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reportData: lastReportData, lang })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);
    if (btn) { btn.textContent = cn ? '‚úÖ Â∑≤‰øùÂ≠ò' : '‚úÖ Saved'; btn.style.borderColor = 'var(--success)'; btn.style.color = 'var(--success)'; }
  } catch(err) {
    alert((cn ? '‰øùÂ≠òÂ§±Ë¥•Ôºö' : 'Save failed: ') + err.message);
    if (btn) { btn.disabled = false; btn.textContent = cn ? 'üíæ ‰øùÂ≠òÊä•Âëä' : 'üíæ Save Report'; }
  }
}

// Init: default to Chinese, check auth
setLang('cn');
checkAuth();

// ===== Scroll Reveal =====
const obs=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting){e.target.style.opacity='1';e.target.style.transform='translateY(0)'}})},{threshold:.08});
document.querySelectorAll('.section,.fda-box').forEach(el=>{el.style.opacity='0';el.style.transform='translateY(24px)';el.style.transition='opacity .6s ease,transform .6s ease';obs.observe(el)});
</script>

</body>
</html>
